---
import LoadingSpinner from '../ui/LoadingSpinner.astro';
import ErrorMessage from '../ui/ErrorMessage.astro';

interface Props {
  title?: string;
  limit?: number;
  showViewAll?: boolean;
  sortBy?: 'createdAt' | 'updatedAt';
  class?: string;
}

const {
  title = 'æœ€æ–°è½¯ä»¶',
  limit = 6, // æœªä½¿ç”¨ä½†ä¿ç•™æ¥å£å…¼å®¹æ€§
  showViewAll = true,
  sortBy = 'updatedAt', // æœªä½¿ç”¨ä½†ä¿ç•™æ¥å£å…¼å®¹æ€§
  class: className = ''
} = Astro.props;
---

<section class={`${className}`}>
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-gray-900">{title}</h2>
    {showViewAll && (
      <a 
        href="/software?sortBy=updatedAt&sortOrder=desc" 
        class="text-primary-600 hover:text-primary-700 font-medium text-sm flex items-center"
      >
        æŸ¥çœ‹å…¨éƒ¨
        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    )}
  </div>

  <!-- åŠ è½½çŠ¶æ€ -->
  <div id="latest-software-loading" class="flex justify-center py-12">
    <LoadingSpinner size="lg" text="æ­£åœ¨åŠ è½½æœ€æ–°è½¯ä»¶..." />
  </div>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <div id="latest-software-error" class="hidden">
    <ErrorMessage 
      title="åŠ è½½å¤±è´¥" 
      message="æ— æ³•åŠ è½½æœ€æ–°è½¯ä»¶ï¼Œè¯·ç¨åé‡è¯•"
    />
    <div class="text-center mt-4">
      <button 
        id="latest-software-retry" 
        class="btn btn-primary"
      >
        é‡æ–°åŠ è½½
      </button>
    </div>
  </div>

  <!-- è½¯ä»¶åˆ—è¡¨ -->
  <div id="latest-software-container" class="hidden">
    <!-- è½¯ä»¶å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
  </div>

  <!-- ç©ºçŠ¶æ€ -->
  <div id="latest-software-empty" class="hidden text-center py-12">
    <div class="text-gray-400 text-6xl mb-4">ğŸ“¦</div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— è½¯ä»¶</h3>
    <p class="text-gray-500">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è½¯ä»¶</p>
  </div>
</section>

<script is:inline>
  import { getApiClient } from '../../lib/api';

  // ç§»é™¤TypeScript interfaceå£°æ˜
  // ä½¿ç”¨æ™®é€šJavaScriptç±»å’Œå±æ€§
  
  class LatestSoftwareComponent {
    container = null;
    loadingElement = null;
    errorElement = null;
    emptyElement = null;
    retryButton = null;

    constructor() {
      this.init();
    }

    init() {
      this.container = document.getElementById('latest-software-container');
      this.loadingElement = document.getElementById('latest-software-loading');
      this.errorElement = document.getElementById('latest-software-error');
      this.emptyElement = document.getElementById('latest-software-empty');
      this.retryButton = document.getElementById('latest-software-retry');

      if (this.retryButton) {
        this.retryButton.addEventListener('click', () => this.loadLatestSoftware());
      }

      this.loadLatestSoftware();
    }

    showLoading() {
      this.hideAll();
      this.loadingElement?.classList.remove('hidden');
    }

    showError() {
      this.hideAll();
      this.errorElement?.classList.remove('hidden');
    }

    showEmpty() {
      this.hideAll();
      this.emptyElement?.classList.remove('hidden');
    }

    showContent() {
      this.hideAll();
      this.container?.classList.remove('hidden');
    }

    hideAll() {
      this.loadingElement?.classList.add('hidden');
      this.errorElement?.classList.add('hidden');
      this.emptyElement?.classList.add('hidden');
      this.container?.classList.add('hidden');
    }

    async loadLatestSoftware() {
      this.showLoading();

      try {
        const api = getApiClient();
        const response = await api.getSoftwareList({
          page: 1,
          limit: 6,
          sortBy: 'updatedAt',
          sortOrder: 'desc'
        });

        if (response.success && response.data) {
          const softwareList = response.data;
          
          if (!Array.isArray(softwareList) || softwareList.length === 0) {
            this.showEmpty();
            return;
          }

          this.renderSoftwareList(softwareList);
          this.showContent();
        } else {
          throw new Error(response.message || 'è·å–æœ€æ–°è½¯ä»¶å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½æœ€æ–°è½¯ä»¶å¤±è´¥:', error?.message);
        this.showError();
      }
    }

    renderSoftwareList(softwareList) {
      if (!this.container) return;

      this.container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          ${softwareList.map((software, index) => `
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 relative">
              ${index === 0 ? `
                <div class="absolute -top-2 -right-2 z-10">
                  <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white text-xs font-bold">
                    NEW
                  </div>
                </div>
              ` : ''}
              <div class="p-6">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex-1 min-w-0">
                    <h3 class="text-lg font-semibold text-gray-900 truncate">
                      <a href="/software/${software.id}" class="hover:text-primary-600 transition-colors">
                        ${software.name}
                      </a>
                    </h3>
                    ${software.nameEn ? `<p class="text-sm text-gray-500 truncate mt-1">${software.nameEn}</p>` : ''}
                  </div>
                  <div class="flex flex-col items-end space-y-1 ml-4">
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-primary-100 text-primary-800">
                      v${software.currentVersion}
                    </span>
                    ${software.category ? `
                      <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-800">
                        ${software.category}
                      </span>
                    ` : ''}
                  </div>
                </div>

                ${software.description ? `
                  <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                    ${software.description}
                  </p>
                ` : ''}

                <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                  <div class="flex items-center space-x-4">
                    ${software.viewCount !== undefined ? `
                      <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        ${software.viewCount.toLocaleString()}
                      </span>
                    ` : ''}
                    <span class="flex items-center text-green-600">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      ${this.getTimeAgo(software.updatedAt)}
                    </span>
                  </div>
                </div>

                <div class="flex items-center justify-between">
                  <a href="/software/${software.id}" class="btn btn-outline btn-sm">
                    æŸ¥çœ‹è¯¦æƒ…
                  </a>
                  ${software.latestDownloadUrl ? `
                    <button
                      class="btn btn-primary btn-sm"
                      data-download-url="${software.latestDownloadUrl}"
                      data-show-login-prompt="true"
                      type="button">
                      <span class="download-text">ä¸‹è½½</span>
                      <span class="login-prompt-text hidden">ç™»å½•ä¸‹è½½</span>
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // åˆå§‹åŒ–æ–°æ·»åŠ çš„ä¸‹è½½æŒ‰é’®
      this.initializeDownloadButtons();
    }

    initializeDownloadButtons() {
      // ç­‰å¾…å…¨å±€ä¸‹è½½æŒ‰é’®åˆå§‹åŒ–å‡½æ•°å¯ç”¨
      setTimeout(() => {
        const initFn = window.initializeDownloadButton;
        if (typeof initFn === 'function') {
          const downloadButtons = this.container?.querySelectorAll('[data-download-url]') || [];
          downloadButtons.forEach(button => {
            if (button instanceof HTMLElement) {
              initFn(button);
            }
          });
        }
      }, 100);
    }

    getTimeAgo(dateString) {
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

        if (diffInSeconds < 60) return 'åˆšåˆš';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}åˆ†é’Ÿå‰`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}å°æ—¶å‰`;
        if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}å¤©å‰`;
        
        return date.toLocaleDateString('zh-CN', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch {
        return dateString;
      }
    }
  }

  // åˆå§‹åŒ–ç»„ä»¶
  document.addEventListener('DOMContentLoaded', () => {
    new LatestSoftwareComponent();
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
