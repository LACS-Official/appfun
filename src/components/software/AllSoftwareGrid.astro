---
import LoadingSpinner from '../ui/LoadingSpinner.astro';
import ErrorMessage from '../ui/ErrorMessage.astro';

interface Props {
  title?: string;
  limit?: number;
  showViewAll?: boolean;
  class?: string;
}

const {
  title = 'ÂÖ®ÈÉ®ËΩØ‰ª∂',
  limit = 20,
  showViewAll = true,
  class: className = ''
} = Astro.props;
---

<section class={`${className}`}>
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">{title}</h2>
    {showViewAll && (
      <a 
        href="/software" 
        class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 font-medium text-sm flex items-center transition-colors"
      >
        Êü•ÁúãÂÖ®ÈÉ®
        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    )}
  </div>

  <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
  <div id="all-software-loading" class="flex justify-center py-12">
    <LoadingSpinner size="lg" text="Ê≠£Âú®Âä†ËΩΩËΩØ‰ª∂ÂàóË°®..." />
  </div>

  <!-- ÈîôËØØÁä∂ÊÄÅ -->
  <div id="all-software-error" class="hidden">
    <ErrorMessage 
      title="Âä†ËΩΩÂ§±Ë¥•" 
      message="Êó†Ê≥ïÂä†ËΩΩËΩØ‰ª∂ÂàóË°®ÔºåËØ∑Á®çÂêéÈáçËØï"
    />
    <div class="text-center mt-4">
      <button 
        id="all-software-retry" 
        class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md transition-colors"
      >
        ÈáçÊñ∞Âä†ËΩΩ
      </button>
    </div>
  </div>

  <!-- ËΩØ‰ª∂ÁΩëÊ†º -->
  <div id="all-software-container" class="hidden" data-limit={limit}>
    <!-- ËΩØ‰ª∂Âç°ÁâáÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
  </div>

  <!-- Á©∫Áä∂ÊÄÅ -->
  <div id="all-software-empty" class="hidden text-center py-12">
    <div class="text-gray-400 dark:text-gray-600 text-6xl mb-4">üì¶</div>
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">ÊöÇÊó†ËΩØ‰ª∂</h3>
    <p class="text-gray-500 dark:text-gray-400">ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïËΩØ‰ª∂</p>
  </div>
</section>

<script>
  // ÂÆö‰πâËΩØ‰ª∂Á±ªÂûãÊé•Âè£
  interface Software {
    id: string;
    name: string;
    description?: string;
    icon?: string;
    currentVersion?: string;
    viewCount?: number;
    updatedAt?: string;
  }

  class AllSoftwareGridComponent {
    container: HTMLElement | null;
    loadingElement: HTMLElement | null;
    errorElement: HTMLElement | null;
    emptyElement: HTMLElement | null;
    retryButton: HTMLElement | null;
    limit: number;

    constructor(limit: number = 20) {
      this.container = null;
      this.loadingElement = null;
      this.errorElement = null;
      this.emptyElement = null;
      this.retryButton = null;
      this.limit = limit;
      this.init();
    }

    init(): void {
      this.container = document.getElementById('all-software-container');
      this.loadingElement = document.getElementById('all-software-loading');
      this.errorElement = document.getElementById('all-software-error');
      this.emptyElement = document.getElementById('all-software-empty');
      this.retryButton = document.getElementById('all-software-retry');

      if (this.retryButton) {
        this.retryButton.addEventListener('click', () => this.loadAllSoftware());
      }

      this.loadAllSoftware();
    }

    showLoading(): void {
      this.hideAll();
      this.loadingElement?.classList.remove('hidden');
    }

    showError(): void {
      this.hideAll();
      this.errorElement?.classList.remove('hidden');
    }

    showEmpty(): void {
      this.hideAll();
      this.emptyElement?.classList.remove('hidden');
    }

    showContent(): void {
      this.hideAll();
      this.container?.classList.remove('hidden');
    }

    hideAll(): void {
      this.loadingElement?.classList.add('hidden');
      this.errorElement?.classList.add('hidden');
      this.emptyElement?.classList.add('hidden');
      this.container?.classList.add('hidden');
    }

    async loadAllSoftware(): Promise<void> {
      this.showLoading();

      try {
        const checkApiClient = (): Promise<any> => {
          return new Promise((resolve, reject) => {
            let attempts = 0;
            const interval = setInterval(() => {
              attempts++;
              if (window.apiClient) {
                clearInterval(interval);
                resolve(window.apiClient);
              } else if (attempts > 50) {
                clearInterval(interval);
                reject(new Error('APIÂÆ¢Êà∑Á´ØÂàùÂßãÂåñË∂ÖÊó∂'));
              }
            }, 100);
          });
        };

        const api = await checkApiClient();
        
        const response = await api.getSoftwareList({
          page: 1,
          limit: this.limit
        });

        if (response.success && response.data && response.data.software) {
          const softwareList: Software[] = response.data.software;

          if (!Array.isArray(softwareList) || softwareList.length === 0) {
            this.showEmpty();
            return;
          }

          this.renderSoftwareGrid(softwareList);
          this.showContent();
        } else {
          throw new Error(response.message || 'Ëé∑ÂèñËΩØ‰ª∂ÂàóË°®Â§±Ë¥•');
        }
      } catch (error) {
        console.error('Âä†ËΩΩËΩØ‰ª∂ÂàóË°®Â§±Ë¥•:', error);
        this.showError();
      }
    }

    renderSoftwareGrid(softwareList: Software[]): void {
      if (!this.container) return;

      this.container.innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          ${softwareList.map((software) => `
            <div class="group bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 hover:border-primary-200 dark:hover:border-primary-800 shadow-sm hover:shadow-lg transition-all duration-300 cursor-pointer flex flex-col h-full overflow-hidden" onclick="window.location.href='/software/${software.id}'">
              <div class="p-5 flex-1 flex flex-col">
                <!-- Â§¥ÈÉ®ÂõæÊ†áÂíåÊ†áÈ¢ò -->
                <div class="flex items-start space-x-4 mb-4">
                  <div class="flex-shrink-0">
                    ${software.icon ? 
                      `<img src="${software.icon}" alt="${software.name}" class="w-12 h-12 rounded-xl object-cover shadow-sm group-hover:scale-105 transition-transform duration-300" loading="lazy">` : 
                      `<div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary-100 to-primary-200 dark:from-primary-900 dark:to-primary-800 text-primary-600 dark:text-primary-300 flex items-center justify-center text-xl font-bold shadow-inner">${software.name.charAt(0)}</div>`
                    }
                  </div>
                  <div class="flex-1 min-w-0 pt-1">
                    <h3 class="text-base font-bold text-gray-900 dark:text-white truncate group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">
                      ${software.name}
                    </h3>
                    <div class="flex items-center mt-1">
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                        v${software.currentVersion || '1.0'}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- ÊèèËø∞ -->
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 line-clamp-2 flex-1">
                  ${software.description || 'ÊöÇÊó†ÊèèËø∞'}
                </p>

                <!-- Â∫ïÈÉ®‰ø°ÊÅØ -->
                <div class="flex items-center justify-between text-xs text-gray-400 dark:text-gray-500 mt-auto pt-3 border-t border-gray-50 dark:border-gray-700/50">
                  <div class="flex items-center space-x-3">
                    <span class="flex items-center" title="ÊµèËßàÈáè">
                      <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                      ${this.formatNumber(software.viewCount || 0)}
                    </span>
                    <span class="flex items-center" title="Êõ¥Êñ∞Êó∂Èó¥">
                      <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                      ${this.formatTimeAgo(software.updatedAt || '')}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- ÊÇ¨ÂÅúÊòæÁ§∫ÁöÑ‰∏ãËΩΩÊåâÈíÆ -->
            </div>
          `).join('')}
        </div>
      `;
    }

    formatNumber(num: number): string {
      if (!num) return '0';
      if (num >= 10000) {
        return (num / 10000).toFixed(1) + 'w';
      }
      return num.toLocaleString();
    }

    formatTimeAgo(dateString: string): string {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

        if (diffInSeconds < 60) return 'ÂàöÂàö';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}ÂàÜÈíüÂâç`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}Â∞èÊó∂Ââç`;
        if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}Â§©Ââç`;

        return date.toLocaleDateString('zh-CN', {
          month: 'numeric',
          day: 'numeric'
        });
      } catch {
        return '';
      }
    }
  }

  // ÂàùÂßãÂåñÁªÑ‰ª∂
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('all-software-container');
    const limit = container ? parseInt(container.getAttribute('data-limit') || '20', 10) : 20;
    new AllSoftwareGridComponent(limit);
  });
</script>