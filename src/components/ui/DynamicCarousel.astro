---
import LoadingSpinner from './LoadingSpinner.astro';
import ErrorMessage from './ErrorMessage.astro';

interface Props {
  websiteId?: number;
  autoPlay?: boolean;
  interval?: number;
  class?: string;
  limit?: number;
}

const {
  websiteId = 1,
  autoPlay = true,
  interval = 5000,
  class: className = '',
  limit = 10
} = Astro.props;
---

<div class={`relative w-full h-full overflow-hidden rounded-2xl bg-gray-100 dark:bg-gray-800 shadow-xl ${className}`} id="dynamic-carousel">
  <!-- åŠ è½½çŠ¶æ€ -->
  <div id="carousel-loading" class="flex items-center justify-center h-full bg-gray-50 dark:bg-gray-800">
    <div class="text-center">
      <LoadingSpinner size="lg" />
      <p id="loading-message" class="mt-4 text-gray-600 dark:text-gray-400 font-medium">æ­£åœ¨åŠ è½½ç²¾å½©å†…å®¹...</p>
    </div>
  </div>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <div id="carousel-error" class="hidden flex items-center justify-center h-full bg-gray-50 dark:bg-gray-800">
    <div class="text-center p-6">
      <div class="text-5xl mb-4 text-gray-400 dark:text-gray-500">âš ï¸</div>
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">åŠ è½½å¤±è´¥</h3>
      <p id="error-message" class="text-gray-600 dark:text-gray-400 mb-6 text-sm">æ— æ³•è·å–æœ€æ–°å†…å®¹ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</p>
      <button
        id="carousel-retry"
        class="px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200"
      >
        é‡è¯•
      </button>
    </div>
  </div>

  <!-- ç©ºçŠ¶æ€ -->
  <div id="carousel-empty" class="hidden flex items-center justify-center h-full bg-gray-50 dark:bg-gray-800">
    <div class="text-center text-gray-500 dark:text-gray-400">
      <div class="text-6xl mb-4 opacity-50">ğŸ–¼ï¸</div>
      <h3 class="text-lg font-medium mb-2">æš‚æ— å†…å®¹</h3>
      <p class="text-sm opacity-75">æ•¬è¯·æœŸå¾…æ›´å¤šç²¾å½©å†…å®¹</p>
    </div>
  </div>

  <!-- è½®æ’­å›¾å®¹å™¨ -->
  <div id="carousel-content" class="hidden relative w-full h-full group">
    <!-- è½®æ’­å›¾ç‰‡å®¹å™¨ -->
    <div id="slides-container" class="relative w-full h-full">
      <!-- åŠ¨æ€ç”Ÿæˆçš„è½®æ’­å›¾å°†åœ¨è¿™é‡Œ -->
    </div>

    <!-- å¯¼èˆªç‚¹å®¹å™¨ -->
    <div id="dots-container" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex items-center space-x-3 z-10 px-4 py-2 rounded-full bg-black/20 backdrop-blur-sm">
      <!-- åŠ¨æ€ç”Ÿæˆçš„å¯¼èˆªç‚¹å°†åœ¨è¿™é‡Œ -->
    </div>

    <!-- å·¦å³ç®­å¤´ -->
    <button 
      class="absolute left-4 top-1/2 transform -translate-y-1/2 w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-white/30 backdrop-blur-md border border-white/20 text-white rounded-full transition-all duration-300 opacity-0 group-hover:opacity-100 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-white/50"
      id="carousel-prev-btn"
      aria-label="ä¸Šä¸€å¼ "
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>

    <button 
      class="absolute right-4 top-1/2 transform -translate-y-1/2 w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-white/30 backdrop-blur-md border border-white/20 text-white rounded-full transition-all duration-300 opacity-0 group-hover:opacity-100 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-white/50"
      id="carousel-next-btn"
      aria-label="ä¸‹ä¸€å¼ "
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
  </div>
</div>

<script define:vars={{ websiteId, autoPlay, interval, limit }}>
  class DynamicCarouselComponent {
    constructor() {
      this.websiteId = websiteId;
      this.autoPlay = autoPlay;
      this.interval = interval;
      this.limit = limit;
      this.currentSlide = 0;
      this.totalSlides = 0;
      this.autoPlayTimer = null;
      this.banners = [];
      
      this.loadingElement = document.getElementById('carousel-loading');
      this.errorElement = document.getElementById('carousel-error');
      this.emptyElement = document.getElementById('carousel-empty');
      this.contentElement = document.getElementById('carousel-content');
      this.slidesContainer = document.getElementById('slides-container');
      this.dotsContainer = document.getElementById('dots-container');
      this.retryButton = document.getElementById('carousel-retry');
      this.prevButton = document.getElementById('carousel-prev-btn');
      this.nextButton = document.getElementById('carousel-next-btn');
      
      this.init();
    }

    init() {
      this.setupEventListeners();
      this.loadBanners();
    }

    setupEventListeners() {
      if (this.retryButton) {
        this.retryButton.addEventListener('click', () => this.loadBanners());
      }

      if (this.prevButton) {
        this.prevButton.addEventListener('click', () => this.prevSlide());
      }

      if (this.nextButton) {
        this.nextButton.addEventListener('click', () => this.nextSlide());
      }

      // é¼ æ ‡æ‚¬åœæš‚åœè‡ªåŠ¨æ’­æ”¾
      const carousel = document.getElementById('dynamic-carousel');
      if (carousel) {
        carousel.addEventListener('mouseenter', () => this.stopAutoPlay());
        carousel.addEventListener('mouseleave', () => {
          if (this.autoPlay && this.totalSlides > 1) {
            this.startAutoPlay();
          }
        });
      }
    }

    showLoading(message = 'æ­£åœ¨åŠ è½½ç²¾å½©å†…å®¹...') {
      this.hideAll();
      this.loadingElement?.classList.remove('hidden');

      // æ›´æ–°åŠ è½½æ¶ˆæ¯
      const loadingMessageEl = document.getElementById('loading-message');
      if (loadingMessageEl) {
        loadingMessageEl.textContent = message;
      }
    }

    showError(message = 'æ— æ³•åŠ è½½å†…å®¹') {
      this.hideAll();
      this.errorElement?.classList.remove('hidden');

      // æ›´æ–°é”™è¯¯æ¶ˆæ¯
      const errorMessageEl = document.getElementById('error-message');
      if (errorMessageEl) {
        errorMessageEl.textContent = message;
      }
    }

    showEmpty() {
      this.hideAll();
      this.emptyElement?.classList.remove('hidden');
    }

    showContent() {
      this.hideAll();
      this.contentElement?.classList.remove('hidden');
    }

    hideAll() {
      this.loadingElement?.classList.add('hidden');
      this.errorElement?.classList.add('hidden');
      this.emptyElement?.classList.add('hidden');
      this.contentElement?.classList.add('hidden');
    }

    async loadBanners(retryCount = 0) {
      if (retryCount === 0) {
        this.showLoading('æ­£åœ¨åˆå§‹åŒ–...');
      } else {
        this.showLoading(`å°è¯•é‡æ–°è¿æ¥ (${retryCount + 1}/3)...`);
      }

      try {
        // ç­‰å¾…APIå®¢æˆ·ç«¯å°±ç»ª
        const api = await this.waitForApiClient();

        this.showLoading('æ­£åœ¨è·å–æœ€æ–°æ¨è...');

        const response = await api.getBanners(this.websiteId, {
          limit: this.limit,
          isActive: true
        });

        console.log('Banners Response:', response);

        if (response.success && response.data && response.data.banners) {
          this.banners = response.data.banners.filter(banner => banner.isActive);

          if (this.banners.length === 0) {
            this.showEmpty();
            return;
          }

          // æŒ‰sortOrderæ’åº
          this.banners.sort((a, b) => a.sortOrder - b.sortOrder);

          this.totalSlides = this.banners.length;
          this.renderCarousel();
          this.showContent();

          if (this.autoPlay && this.totalSlides > 1) {
            this.startAutoPlay();
          }
        } else {
          throw new Error(response.message || 'è·å–æ•°æ®å¤±è´¥');
        }
      } catch (error) {
        console.error(`åŠ è½½å¤±è´¥ (å°è¯• ${retryCount + 1}):`, error);

        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ä¸”é‡è¯•æ¬¡æ•°å°‘äº3æ¬¡ï¼Œåˆ™è‡ªåŠ¨é‡è¯•
        if (retryCount < 2 && (error.message.includes('ç½‘ç»œ') || error.message.includes('timeout') || error.message.includes('fetch'))) {
          console.log(`å°†åœ¨ ${(retryCount + 1) * 1000}ms åè‡ªåŠ¨é‡è¯•...`);
          setTimeout(() => {
            this.loadBanners(retryCount + 1);
          }, (retryCount + 1) * 1000);
        } else {
          this.showError(`åŠ è½½å¤±è´¥: ${error.message}`);
        }
      }
    }

    // ç­‰å¾…APIå®¢æˆ·ç«¯å°±ç»ª
    async waitForApiClient(maxAttempts = 30, interval = 100) {
      return new Promise((resolve, reject) => {
        let attempts = 0;

        const checkApiClient = () => {
          attempts++;

          if (window.apiClient) {
            resolve(window.apiClient);
          } else if (attempts >= maxAttempts) {
            reject(new Error('è¿æ¥è¶…æ—¶ï¼Œè¯·åˆ·æ–°é‡è¯•'));
          } else {
            setTimeout(checkApiClient, interval);
          }
        };

        checkApiClient();
      });
    }

    renderCarousel() {
      if (!this.slidesContainer || !this.dotsContainer) return;

      // æ¸²æŸ“è½®æ’­å›¾ç‰‡
      this.slidesContainer.innerHTML = this.banners.map((banner, index) => `
        <div
          class="absolute inset-0 transition-all duration-700 ease-in-out transform ${index === 0 ? 'opacity-100 scale-100 z-10' : 'opacity-0 scale-105 z-0'}"
          data-slide="${index}"
        >
          ${banner.linkUrl ? `
            <a href="${banner.linkUrl}" target="${banner.linkTarget || '_self'}" class="block w-full h-full" data-banner-id="${banner.id}">
              ${this.renderSlideContent(banner)}
            </a>
          ` : `
            <div class="w-full h-full">
              ${this.renderSlideContent(banner)}
            </div>
          `}
        </div>
      `).join('');

      // æ¸²æŸ“å¯¼èˆªç‚¹
      this.dotsContainer.innerHTML = this.banners.map((_, index) => `
        <button
          class="h-2 rounded-full transition-all duration-300 ${
            index === 0 ? 'w-6 bg-white' : 'w-2 bg-white/50 hover:bg-white/80'
          }"
          data-slide-to="${index}"
          aria-label="åˆ‡æ¢åˆ°ç¬¬ ${index + 1} å¼ å›¾ç‰‡"
        ></button>
      `).join('');

      // ç»‘å®šå¯¼èˆªç‚¹äº‹ä»¶
      this.dotsContainer.querySelectorAll('[data-slide-to]').forEach(dot => {
        dot.addEventListener('click', (e) => {
          const slideIndex = parseInt(e.target.getAttribute('data-slide-to'));
          this.goToSlide(slideIndex);
        });
      });

      // ç»‘å®šè½®æ’­å›¾ç‚¹å‡»äº‹ä»¶
      this.slidesContainer.querySelectorAll('[data-banner-id]').forEach(link => {
        link.addEventListener('click', (e) => {
          const bannerId = parseInt(e.currentTarget.getAttribute('data-banner-id'));
          this.trackClick(bannerId);
        });
      });

      // å¦‚æœåªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œéšè—å¯¼èˆªæ§ä»¶
      if (this.totalSlides <= 1) {
        this.dotsContainer.style.display = 'none';
        if (this.prevButton) this.prevButton.style.display = 'none';
        if (this.nextButton) this.nextButton.style.display = 'none';
      }
    }

    renderSlideContent(banner) {
      return `
        <div class="relative w-full h-full">
          <img
            src="${banner.imageUrl}"
            alt="${banner.imageAlt || banner.title}"
            class="w-full h-full object-cover"
            loading="lazy"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨å†…å®¹ -->
          <div class="hidden w-full h-full bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center">
            <div class="text-center text-white p-8">
              <div class="text-6xl mb-4">ğŸ–¼ï¸</div>
              <h3 class="text-2xl font-bold mb-2">${banner.title}</h3>
              ${banner.description ? `<p class="text-primary-100">${banner.description}</p>` : ''}
            </div>
          </div>
          <!-- æ–‡å­—è¦†ç›–å±‚ -->
          ${banner.title || banner.description ? `
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-8 pt-24">
              <div class="text-white transform translate-y-0 transition-transform duration-500">
                ${banner.title ? `<h3 class="text-2xl font-bold mb-2 drop-shadow-md">${banner.title}</h3>` : ''}
                ${banner.description ? `<p class="text-base text-gray-200 line-clamp-2 drop-shadow-sm max-w-2xl">${banner.description}</p>` : ''}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    goToSlide(index) {
      if (index < 0 || index >= this.totalSlides) return;
      if (index === this.currentSlide) return;

      // éšè—å½“å‰å¹»ç¯ç‰‡
      const currentSlideEl = this.slidesContainer.querySelector(`[data-slide="${this.currentSlide}"]`);
      if (currentSlideEl) {
        currentSlideEl.classList.remove('opacity-100', 'scale-100', 'z-10');
        currentSlideEl.classList.add('opacity-0', 'scale-105', 'z-0');
      }

      // æ›´æ–°å½“å‰å¯¼èˆªç‚¹
      const currentDot = this.dotsContainer.querySelector(`[data-slide-to="${this.currentSlide}"]`);
      if (currentDot) {
        currentDot.classList.remove('w-6', 'bg-white');
        currentDot.classList.add('w-2', 'bg-white/50');
      }

      // æ˜¾ç¤ºæ–°å¹»ç¯ç‰‡
      this.currentSlide = index;
      const newSlideEl = this.slidesContainer.querySelector(`[data-slide="${this.currentSlide}"]`);
      if (newSlideEl) {
        newSlideEl.classList.remove('opacity-0', 'scale-105', 'z-0');
        newSlideEl.classList.add('opacity-100', 'scale-100', 'z-10');
      }

      // æ›´æ–°æ–°å¯¼èˆªç‚¹
      const newDot = this.dotsContainer.querySelector(`[data-slide-to="${this.currentSlide}"]`);
      if (newDot) {
        newDot.classList.remove('w-2', 'bg-white/50');
        newDot.classList.add('w-6', 'bg-white');
      }
    }

    nextSlide() {
      const nextIndex = (this.currentSlide + 1) % this.totalSlides;
      this.goToSlide(nextIndex);
    }

    prevSlide() {
      const prevIndex = (this.currentSlide - 1 + this.totalSlides) % this.totalSlides;
      this.goToSlide(prevIndex);
    }

    startAutoPlay() {
      this.stopAutoPlay();
      if (this.totalSlides > 1) {
        this.autoPlayTimer = setInterval(() => {
          this.nextSlide();
        }, this.interval);
      }
    }

    stopAutoPlay() {
      if (this.autoPlayTimer) {
        clearInterval(this.autoPlayTimer);
        this.autoPlayTimer = null;
      }
    }

    trackClick(bannerId) {
      console.log(`Clicked banner ${bannerId}`);
      // è¿™é‡Œå¯ä»¥æ·»åŠ ç‚¹å‡»ç»Ÿè®¡é€»è¾‘
    }
  }

  // å½“é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    new DynamicCarouselComponent();
  });
</script>