---
import LoadingSpinner from './LoadingSpinner.astro';
import ErrorMessage from './ErrorMessage.astro';

interface Props {
  websiteId?: number;
  autoPlay?: boolean;
  interval?: number;
  class?: string;
  limit?: number;
}

const {
  websiteId = 1,
  autoPlay = true,
  interval = 5000,
  class: className = '',
  limit = 10
} = Astro.props;
---

<div class={`relative w-full h-full overflow-hidden rounded-lg bg-gray-100 ${className}`} id="dynamic-carousel">
  <!-- åŠ è½½çŠ¶æ€ -->
  <div id="carousel-loading" class="flex items-center justify-center h-full">
    <div class="text-center">
      <LoadingSpinner size="lg" />
      <p id="loading-message" class="mt-4 text-gray-600">æ­£åœ¨åŠ è½½è½®æ’­å›¾...</p>
    </div>
  </div>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <div id="carousel-error" class="hidden flex items-center justify-center h-full">
    <div class="text-center p-6">
      <div class="text-6xl mb-4">âš ï¸</div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">è½®æ’­å›¾åŠ è½½å¤±è´¥</h3>
      <p id="error-message" class="text-gray-600 mb-4">æ— æ³•åŠ è½½è½®æ’­å›¾ï¼Œè¯·ç¨åé‡è¯•</p>
      <button
        id="carousel-retry"
        class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors"
      >
        é‡æ–°åŠ è½½
      </button>
    </div>
  </div>

  <!-- ç©ºçŠ¶æ€ -->
  <div id="carousel-empty" class="hidden flex items-center justify-center h-full">
    <div class="text-center text-gray-500">
      <div class="text-6xl mb-4">ğŸ–¼ï¸</div>
      <h3 class="text-lg font-medium mb-2">æš‚æ— è½®æ’­å›¾</h3>
      <p class="text-sm">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è½®æ’­å›¾å†…å®¹</p>
    </div>
  </div>

  <!-- è½®æ’­å›¾å®¹å™¨ -->
  <div id="carousel-content" class="hidden relative w-full h-full">
    <!-- è½®æ’­å›¾ç‰‡å®¹å™¨ -->
    <div id="slides-container" class="relative w-full h-full">
      <!-- åŠ¨æ€ç”Ÿæˆçš„è½®æ’­å›¾å°†åœ¨è¿™é‡Œ -->
    </div>

    <!-- å¯¼èˆªç‚¹å®¹å™¨ -->
    <div id="dots-container" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
      <!-- åŠ¨æ€ç”Ÿæˆçš„å¯¼èˆªç‚¹å°†åœ¨è¿™é‡Œ -->
    </div>

    <!-- å·¦å³ç®­å¤´ -->
    <button 
      class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-30 hover:bg-opacity-50 text-white p-2 rounded-full transition-all duration-300"
      id="carousel-prev-btn"
      aria-label="ä¸Šä¸€å¼ "
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>

    <button 
      class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-30 hover:bg-opacity-50 text-white p-2 rounded-full transition-all duration-300"
      id="carousel-next-btn"
      aria-label="ä¸‹ä¸€å¼ "
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
  </div>
</div>

<script define:vars={{ websiteId, autoPlay, interval, limit }}>
  class DynamicCarouselComponent {
    constructor() {
      this.websiteId = websiteId;
      this.autoPlay = autoPlay;
      this.interval = interval;
      this.limit = limit;
      this.currentSlide = 0;
      this.totalSlides = 0;
      this.autoPlayTimer = null;
      this.banners = [];
      
      this.loadingElement = document.getElementById('carousel-loading');
      this.errorElement = document.getElementById('carousel-error');
      this.emptyElement = document.getElementById('carousel-empty');
      this.contentElement = document.getElementById('carousel-content');
      this.slidesContainer = document.getElementById('slides-container');
      this.dotsContainer = document.getElementById('dots-container');
      this.retryButton = document.getElementById('carousel-retry');
      this.prevButton = document.getElementById('carousel-prev-btn');
      this.nextButton = document.getElementById('carousel-next-btn');
      
      this.init();
    }

    init() {
      this.setupEventListeners();
      this.loadBanners();
    }

    setupEventListeners() {
      if (this.retryButton) {
        this.retryButton.addEventListener('click', () => this.loadBanners());
      }

      if (this.prevButton) {
        this.prevButton.addEventListener('click', () => this.prevSlide());
      }

      if (this.nextButton) {
        this.nextButton.addEventListener('click', () => this.nextSlide());
      }

      // é¼ æ ‡æ‚¬åœæš‚åœè‡ªåŠ¨æ’­æ”¾
      const carousel = document.getElementById('dynamic-carousel');
      if (carousel) {
        carousel.addEventListener('mouseenter', () => this.stopAutoPlay());
        carousel.addEventListener('mouseleave', () => {
          if (this.autoPlay && this.totalSlides > 1) {
            this.startAutoPlay();
          }
        });
      }
    }

    showLoading(message = 'æ­£åœ¨åŠ è½½è½®æ’­å›¾...') {
      this.hideAll();
      this.loadingElement?.classList.remove('hidden');

      // æ›´æ–°åŠ è½½æ¶ˆæ¯
      const loadingMessageEl = document.getElementById('loading-message');
      if (loadingMessageEl) {
        loadingMessageEl.textContent = message;
      }
    }

    showError(message = 'æ— æ³•åŠ è½½è½®æ’­å›¾ï¼Œè¯·ç¨åé‡è¯•') {
      this.hideAll();
      this.errorElement?.classList.remove('hidden');

      // æ›´æ–°é”™è¯¯æ¶ˆæ¯
      const errorMessageEl = document.getElementById('error-message');
      if (errorMessageEl) {
        errorMessageEl.textContent = message;
      }
    }

    showEmpty() {
      this.hideAll();
      this.emptyElement?.classList.remove('hidden');
    }

    showContent() {
      this.hideAll();
      this.contentElement?.classList.remove('hidden');
    }

    hideAll() {
      this.loadingElement?.classList.add('hidden');
      this.errorElement?.classList.add('hidden');
      this.emptyElement?.classList.add('hidden');
      this.contentElement?.classList.add('hidden');
    }

    async loadBanners(retryCount = 0) {
      if (retryCount === 0) {
        this.showLoading('æ­£åœ¨åˆå§‹åŒ–APIå®¢æˆ·ç«¯...');
      } else {
        this.showLoading(`æ­£åœ¨é‡è¯•åŠ è½½è½®æ’­å›¾ (${retryCount + 1}/3)...`);
      }

      try {
        // ç­‰å¾…APIå®¢æˆ·ç«¯å°±ç»ª
        const api = await this.waitForApiClient();

        this.showLoading('æ­£åœ¨è·å–è½®æ’­å›¾æ•°æ®...');

        const response = await api.getBanners(this.websiteId, {
          limit: this.limit,
          isActive: true
        });

        console.log('Banners Response:', response);

        if (response.success && response.data && response.data.banners) {
          this.banners = response.data.banners.filter(banner => banner.isActive);

          if (this.banners.length === 0) {
            this.showEmpty();
            return;
          }

          // æŒ‰sortOrderæ’åº
          this.banners.sort((a, b) => a.sortOrder - b.sortOrder);

          this.totalSlides = this.banners.length;
          this.renderCarousel();
          this.showContent();

          if (this.autoPlay && this.totalSlides > 1) {
            this.startAutoPlay();
          }
        } else {
          throw new Error(response.message || 'è·å–è½®æ’­å›¾å¤±è´¥');
        }
      } catch (error) {
        console.error(`åŠ è½½è½®æ’­å›¾å¤±è´¥ (å°è¯• ${retryCount + 1}):`, error);

        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ä¸”é‡è¯•æ¬¡æ•°å°‘äº3æ¬¡ï¼Œåˆ™è‡ªåŠ¨é‡è¯•
        if (retryCount < 2 && (error.message.includes('ç½‘ç»œ') || error.message.includes('timeout') || error.message.includes('fetch'))) {
          console.log(`å°†åœ¨ ${(retryCount + 1) * 1000}ms åè‡ªåŠ¨é‡è¯•...`);
          setTimeout(() => {
            this.loadBanners(retryCount + 1);
          }, (retryCount + 1) * 1000);
        } else {
          this.showError(`åŠ è½½å¤±è´¥: ${error.message}`);
        }
      }
    }

    // ç­‰å¾…APIå®¢æˆ·ç«¯å°±ç»ª
    async waitForApiClient(maxAttempts = 30, interval = 100) {
      return new Promise((resolve, reject) => {
        let attempts = 0;

        const checkApiClient = () => {
          attempts++;

          if (window.apiClient) {
            resolve(window.apiClient);
          } else if (attempts >= maxAttempts) {
            reject(new Error('APIå®¢æˆ·ç«¯åˆå§‹åŒ–è¶…æ—¶'));
          } else {
            setTimeout(checkApiClient, interval);
          }
        };

        checkApiClient();
      });
    }

    renderCarousel() {
      if (!this.slidesContainer || !this.dotsContainer) return;

      // æ¸²æŸ“è½®æ’­å›¾ç‰‡
      this.slidesContainer.innerHTML = this.banners.map((banner, index) => `
        <div
          class="absolute inset-0 transition-opacity duration-500 ${index === 0 ? 'opacity-100' : 'opacity-0'}"
          data-slide="${index}"
        >
          ${banner.linkUrl ? `
            <a href="${banner.linkUrl}" target="${banner.linkTarget || '_self'}" class="block w-full h-full" data-banner-id="${banner.id}">
              ${this.renderSlideContent(banner)}
            </a>
          ` : `
            <div class="w-full h-full">
              ${this.renderSlideContent(banner)}
            </div>
          `}
        </div>
      `).join('');

      // æ¸²æŸ“å¯¼èˆªç‚¹
      this.dotsContainer.innerHTML = this.banners.map((_, index) => `
        <button
          class="w-3 h-3 rounded-full transition-all duration-300 ${
            index === 0 ? 'bg-white' : 'bg-white bg-opacity-50'
          }"
          data-slide-to="${index}"
          aria-label="åˆ‡æ¢åˆ°ç¬¬ ${index + 1} å¼ å›¾ç‰‡"
        ></button>
      `).join('');

      // ç»‘å®šå¯¼èˆªç‚¹äº‹ä»¶
      this.dotsContainer.querySelectorAll('[data-slide-to]').forEach(dot => {
        dot.addEventListener('click', (e) => {
          const slideIndex = parseInt(e.target.getAttribute('data-slide-to'));
          this.goToSlide(slideIndex);
        });
      });

      // ç»‘å®šè½®æ’­å›¾ç‚¹å‡»äº‹ä»¶
      this.slidesContainer.querySelectorAll('[data-banner-id]').forEach(link => {
        link.addEventListener('click', (e) => {
          const bannerId = parseInt(e.currentTarget.getAttribute('data-banner-id'));
          this.trackClick(bannerId);
        });
      });

      // å¦‚æœåªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œéšè—å¯¼èˆªæ§ä»¶
      if (this.totalSlides <= 1) {
        this.dotsContainer.style.display = 'none';
        if (this.prevButton) this.prevButton.style.display = 'none';
        if (this.nextButton) this.nextButton.style.display = 'none';
      }
    }

    renderSlideContent(banner) {
      return `
        <div class="relative w-full h-full">
          <img
            src="${banner.imageUrl}"
            alt="${banner.imageAlt || banner.title}"
            class="w-full h-full object-cover"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨å†…å®¹ -->
          <div class="hidden w-full h-full bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center">
            <div class="text-center text-white p-8">
              <div class="text-6xl mb-4">ğŸ–¼ï¸</div>
              <h3 class="text-2xl font-bold mb-2">${banner.title}</h3>
              ${banner.description ? `<p class="text-primary-100">${banner.description}</p>` : ''}
            </div>
          </div>
          <!-- æ–‡å­—è¦†ç›–å±‚ -->
          ${banner.title || banner.description ? `
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-6">
              <div class="text-white">
                ${banner.title ? `<h3 class="text-xl font-bold mb-2">${banner.title}</h3>` : ''}
                ${banner.description ? `<p class="text-sm text-gray-200">${banner.description}</p>` : ''}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    goToSlide(index) {
      if (index < 0 || index >= this.totalSlides) return;

      // éšè—å½“å‰å¹»ç¯ç‰‡
      const currentSlideEl = this.slidesContainer.querySelector(`[data-slide="${this.currentSlide}"]`);
      if (currentSlideEl) {
        currentSlideEl.classList.remove('opacity-100');
        currentSlideEl.classList.add('opacity-0');
      }

      // æ›´æ–°å½“å‰å¯¼èˆªç‚¹
      const currentDot = this.dotsContainer.querySelector(`[data-slide-to="${this.currentSlide}"]`);
      if (currentDot) {
        currentDot.classList.remove('bg-white');
        currentDot.classList.add('bg-white', 'bg-opacity-50');
      }

      // æ˜¾ç¤ºæ–°å¹»ç¯ç‰‡
      this.currentSlide = index;
      const newSlideEl = this.slidesContainer.querySelector(`[data-slide="${this.currentSlide}"]`);
      if (newSlideEl) {
        newSlideEl.classList.remove('opacity-0');
        newSlideEl.classList.add('opacity-100');
      }

      // æ›´æ–°æ–°å¯¼èˆªç‚¹
      const newDot = this.dotsContainer.querySelector(`[data-slide-to="${this.currentSlide}"]`);
      if (newDot) {
        newDot.classList.remove('bg-opacity-50');
        newDot.classList.add('bg-white');
      }
    }

    nextSlide() {
      const nextIndex = (this.currentSlide + 1) % this.totalSlides;
      this.goToSlide(nextIndex);
    }

    prevSlide() {
      const prevIndex = (this.currentSlide - 1 + this.totalSlides) % this.totalSlides;
      this.goToSlide(prevIndex);
    }

    startAutoPlay() {
      this.stopAutoPlay();
      if (this.totalSlides > 1) {
        this.autoPlayTimer = setInterval(() => {
          this.nextSlide();
        }, this.interval);
      }
    }

    stopAutoPlay() {
      if (this.autoPlayTimer) {
        clearInterval(this.autoPlayTimer);
        this.autoPlayTimer = null;
      }
    }

    trackClick(bannerId) {
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç‚¹å‡»ç»Ÿè®¡é€»è¾‘
      console.log(`Banner ${bannerId} clicked`);
    }
  }

  // ç­‰å¾…APIå®¢æˆ·ç«¯å°±ç»ªçš„å‡½æ•°
  function waitForApiClient(maxAttempts = 50, interval = 100) {
    return new Promise((resolve, reject) => {
      let attempts = 0;

      const checkApiClient = () => {
        attempts++;

        if (window.apiClient) {
          console.log(`APIå®¢æˆ·ç«¯å°±ç»ªï¼Œå°è¯•æ¬¡æ•°: ${attempts}`);
          resolve(window.apiClient);
        } else if (attempts >= maxAttempts) {
          console.error(`APIå®¢æˆ·ç«¯åˆå§‹åŒ–è¶…æ—¶ï¼Œå·²å°è¯• ${attempts} æ¬¡`);
          reject(new Error('APIå®¢æˆ·ç«¯åˆå§‹åŒ–è¶…æ—¶'));
        } else {
          setTimeout(checkApiClient, interval);
        }
      };

      checkApiClient();
    });
  }

  // åˆå§‹åŒ–è½®æ’­å›¾
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // ç­‰å¾…APIå®¢æˆ·ç«¯å°±ç»ª
      await waitForApiClient();
      // åˆ›å»ºè½®æ’­å›¾ç»„ä»¶
      new DynamicCarouselComponent();
    } catch (error) {
      console.error('è½®æ’­å›¾åˆå§‹åŒ–å¤±è´¥:', error);
      // å³ä½¿APIå®¢æˆ·ç«¯æœªå°±ç»ªï¼Œä¹Ÿåˆ›å»ºç»„ä»¶ï¼ˆä¼šæ˜¾ç¤ºé”™è¯¯çŠ¶æ€ï¼‰
      new DynamicCarouselComponent();
    }
  });
</script>

<style>
  /* å¼ºåˆ¶16:9å®½é«˜æ¯” */
  #dynamic-carousel {
    aspect-ratio: 16/9;
    width: 100%;
    height: auto;
  }

  /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šä¹Ÿä¿æŒåˆç†çš„æœ€å°é«˜åº¦ */
  @media (max-width: 768px) {
    #dynamic-carousel {
      min-height: 200px;
    }
  }

  @media (min-width: 769px) {
    #dynamic-carousel {
      min-height: 250px;
    }
  }

  /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
  [data-slide] {
    transition: opacity 0.5s ease-in-out;
  }

  /* å¯¼èˆªç‚¹æ‚¬åœæ•ˆæœ */
  [data-slide-to]:hover {
    transform: scale(1.2);
  }

  /* ç®­å¤´æŒ‰é’®æ‚¬åœæ•ˆæœ */
  #carousel-prev-btn:hover,
  #carousel-next-btn:hover {
    transform: translateY(-50%) scale(1.1);
  }

  /* å›¾ç‰‡æ ·å¼ */
  img {
    transition: transform 0.3s ease;
  }

  img:hover {
    transform: scale(1.02);
  }
</style>
