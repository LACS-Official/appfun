---
import Layout from '../../layouts/Layout.astro';
import LoadingSpinner from '../../components/ui/LoadingSpinner.astro';
import { createClient } from '../../lib/supabase/client';
// ä¸ºé™æ€ç”Ÿæˆæä¾›è·¯å¾„
export async function getStaticPaths() {
  try {
    // ä»APIè·å–è½¯ä»¶åˆ—è¡¨ä»¥è·å–æ‰€æœ‰ID
    const response = await fetch('https://api-g.lacs.cc/app/software');
    
    if (!response.ok) {
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    }
    
    const data = await response.json();
    
    // æ£€æŸ¥å“åº”æ•°æ®æ ¼å¼
    if (!data.success || !data.data || !Array.isArray(data.data.software)) {
      throw new Error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®');
    }
    
    // ä»è½¯ä»¶åˆ—è¡¨ä¸­æå–ID
    const softwareIds = data.data.software.map((software: { id: number }) => software.id.toString());
    
    // ä¸ºæ¯ä¸ªIDç”Ÿæˆè·¯å¾„å‚æ•°
    return softwareIds.map((id: string) => ({
      params: { id }
    }));
  } catch (error) {
    console.error('è·å–è½¯ä»¶IDåˆ—è¡¨å¤±è´¥:', error);
    
    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨IDåˆ—è¡¨ç¡®ä¿è‡³å°‘èƒ½ç”Ÿæˆä¸€äº›é¡µé¢
    const fallbackIds = ['1', '2', '3'];
    return fallbackIds.map((id: string) => ({
      params: { id }
    }));
  }
}

const { id } = Astro.params;

if (!id || isNaN(Number(id))) {
  return Astro.redirect('/');
}

// SEO å…ƒæ•°æ®
const title = 'è½¯ä»¶è¯¦æƒ…';
const description = 'æŸ¥çœ‹è½¯ä»¶çš„è¯¦ç»†ä¿¡æ¯ã€ç‰ˆæœ¬å†å²å’Œä¸‹è½½é“¾æ¥ã€‚åœ¨APPFUNä¸Šè·å–æœ€æ–°ç‰ˆæœ¬çš„è½¯ä»¶ï¼Œäº†è§£è½¯ä»¶åŠŸèƒ½ã€å¤§å°ã€æ›´æ–°æ—¶é—´ç­‰è¯¦ç»†ä¿¡æ¯';
const keywords = 'è½¯ä»¶è¯¦æƒ…,è½¯ä»¶ä¸‹è½½,è½¯ä»¶ç‰ˆæœ¬,è½¯ä»¶ä¿¡æ¯,APPFUN';
const canonical = `https://appfun.fun/software/${id}`;
const structuredData = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "",
  "description": "",
  "url": canonical,
  "applicationCategory": "",
  "operatingSystem": "",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "CNY"
  }
};
---

<Layout 
  title={title} 
  description={description} 
  keywords={keywords}
  canonical={canonical}
  structuredDataType="software"
  structuredData={structuredData}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- è½¯ä»¶ä¿¡æ¯å®¹å™¨ -->
    <div id="software-container">
      <div class="flex justify-center py-12">
        <LoadingSpinner size="lg" text="æ­£åœ¨åŠ è½½è½¯ä»¶ä¿¡æ¯..." />
      </div>
    </div>

    <!-- ç‰ˆæœ¬å†å² -->
    <section class="mt-12" id="versions-section" style="display: none;">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900">ç‰ˆæœ¬å†å²</h2>
        <div class="flex items-center space-x-4">
          <select id="version-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-primary-500">
            <option value="all">æ‰€æœ‰ç‰ˆæœ¬</option>
            <option value="release">æ­£å¼ç‰ˆ</option>
            <option value="beta">æµ‹è¯•ç‰ˆ</option>
            <option value="alpha">å†…æµ‹ç‰ˆ</option>
          </select>
        </div>
      </div>
      
      <div id="versions-container">
        <div class="flex justify-center py-8">
          <LoadingSpinner size="md" text="æ­£åœ¨åŠ è½½ç‰ˆæœ¬å†å²..." />
        </div>
      </div>
    </section>

    <!-- å…¬å‘Š -->
    <section class="mt-12" id="announcements-section" style="display: none;">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">ç›¸å…³å…¬å‘Š</h2>
      <div id="announcements-container">
        <div class="flex justify-center py-8">
          <LoadingSpinner size="md" text="æ­£åœ¨åŠ è½½å…¬å‘Š..." />
        </div>
      </div>
    </section>
  </div>
</Layout>

<script define:vars={{ id }} is:inline>
  // ç”±äºè¿™æ˜¯åœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„è„šæœ¬ï¼Œæˆ‘ä»¬éœ€è¦ç›´æ¥å®šä¹‰è¿™äº›å‡½æ•°è€Œä¸æ˜¯å¯¼å…¥
  // API é…ç½®
  const apiConfig = {
    baseUrl: 'https://api-g.lacs.cc',
    apiKey: '', // æš‚æ—¶ä¸ºç©ºï¼Œå› ä¸ºAPIæµ‹è¯•æ˜¾ç¤ºä¸éœ€è¦API Key
    timeout: 10000,
  };

  // å…¨å±€å˜é‡ï¼Œç”¨äºè·Ÿè¸ªç™»å½•çŠ¶æ€
  let globalLoginState = false;

  // å·¥å…·å‡½æ•°
  function formatDate(date, options = {}) {
    const dateObj = typeof date === 'string' ? new Date(date) : date;
    const defaultOptions = {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    };
    return dateObj.toLocaleDateString('zh-CN', { ...defaultOptions, ...options });
  }

  function getPriorityDownloadLink(downloadLinks) {
    if (!downloadLinks) return null;
    const priorities = ['official', 'github', 'quark', 'pan123', 'baidu', 'thunder'];
    for (const priority of priorities) {
      if (downloadLinks[priority]) {
        return downloadLinks[priority];
      }
    }
    if (downloadLinks.backup && downloadLinks.backup.length > 0) {
      return downloadLinks.backup[0];
    }
    return null;
  }

  // API å®¢æˆ·ç«¯ç±»
  class ApiClient {
    constructor(config) {
      this.config = {
        timeout: 10000,
        ...config,
      };
    }

    async request(endpoint, options = {}) {
      const url = `${this.config.baseUrl}${endpoint}`;
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers,
      };

      if (this.config.apiKey) {
        headers['X-API-Key'] = this.config.apiKey;
      }

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), this.config.timeout);

      try {
        const response = await fetch(url, {
          ...options,
          headers,
          signal: controller.signal,
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('è¯·æ±‚è¶…æ—¶');
        }
        throw error;
      }
    }

    async get(endpoint, params) {
      const queryString = params ? new URLSearchParams(params).toString() : '';
      const url = queryString ? `${endpoint}?${queryString}` : endpoint;
      return this.request(url);
    }

    async getSoftwareById(id) {
      return this.get(`/app/software/id/${id}`);
    }

    async getSoftwareVersions(softwareId, params) {
      return this.get(`/app/software/id/${softwareId}/versions`, params);
    }

    async getSoftwareAnnouncements(softwareId, params) {
      return this.get(`/app/software/id/${softwareId}/announcements`, params);
    }
  }

  // åˆå§‹åŒ–å…¨å±€ç™»å½•çŠ¶æ€æ£€æŸ¥
  async function checkGlobalLoginStatus() {
    try {
      // é¦–å…ˆæ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰ç™»å½•çŠ¶æ€
      const storedLoginState = localStorage.getItem('isLoggedIn');
      if (storedLoginState !== null) {
        globalLoginState = storedLoginState === 'true';
        // æ›´æ–°æ‰€æœ‰ä¸‹è½½æŒ‰é’®çš„çŠ¶æ€
        updateAllDownloadButtons();
        return globalLoginState;
      }
      
      // å¦‚æœlocalStorageä¸­æ²¡æœ‰ï¼Œå°è¯•ä»APIè·å–
      const response = await fetch('/api/auth/status', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const data = await response.json();
        globalLoginState = !!data.user;
        // å­˜å‚¨åˆ°localStorage
        localStorage.setItem('isLoggedIn', globalLoginState.toString());
        // æ›´æ–°æ‰€æœ‰ä¸‹è½½æŒ‰é’®çš„çŠ¶æ€
        updateAllDownloadButtons();
      } else {
        globalLoginState = false;
        localStorage.setItem('isLoggedIn', 'false');
        // æ›´æ–°æ‰€æœ‰ä¸‹è½½æŒ‰é’®çš„çŠ¶æ€
        updateAllDownloadButtons();
      }
    } catch (error) {
      console.error('æ£€æŸ¥å…¨å±€ç™»å½•çŠ¶æ€å¤±è´¥:', error);
      globalLoginState = false;
      localStorage.setItem('isLoggedIn', 'false');
      // æ›´æ–°æ‰€æœ‰ä¸‹è½½æŒ‰é’®çš„çŠ¶æ€
      updateAllDownloadButtons();
    }
    return globalLoginState;
  }

  // æ›´æ–°æ‰€æœ‰ä¸‹è½½æŒ‰é’®çš„çŠ¶æ€
  function updateAllDownloadButtons() {
    const downloadButtons = document.querySelectorAll('[data-download-url]');
    downloadButtons.forEach(button => {
      const downloadText = button.querySelector('.download-text');
      const loginPromptText = button.querySelector('.login-prompt-text');
      
      if (globalLoginState) {
        // å·²ç™»å½•çŠ¶æ€ - æ˜¾ç¤º"ç«‹å³ä¸‹è½½"
        button.classList.remove('bg-orange-500', 'hover:bg-orange-600');
        button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        
        if (downloadText && loginPromptText) {
          downloadText.classList.remove('hidden');
          loginPromptText.classList.add('hidden');
        }
      } else {
        // æœªç™»å½•çŠ¶æ€ - æ˜¾ç¤º"è¯·ç™»å½•åä¸‹è½½"
        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        button.classList.add('bg-orange-500', 'hover:bg-orange-600');
        
        if (downloadText && loginPromptText) {
          downloadText.classList.add('hidden');
          loginPromptText.classList.remove('hidden');
        }
      }
    });
  }

  // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
  checkGlobalLoginStatus();

  // åˆå§‹åŒ– API å®¢æˆ·ç«¯
  const apiClient = new ApiClient(apiConfig);

  let softwareData = null;
  let currentVersionFilter = 'all';

  document.addEventListener('DOMContentLoaded', () => {
    // å†æ¬¡æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkGlobalLoginStatus();
    
    loadSoftwareDetails(id);
    setupEventListeners();
  });

  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  function setupEventListeners() {
    const versionFilter = document.getElementById('version-filter');
    if (versionFilter) {
      versionFilter.addEventListener('change', (e) => {
        currentVersionFilter = e.target.value;
        loadVersions();
      });
    }
  }

  // åŠ è½½è½¯ä»¶è¯¦æƒ…
  async function loadSoftwareDetails(id) {
    const container = document.getElementById('software-container');
    if (!container) {
      console.error('è½¯ä»¶å®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
      return;
    }

    console.log('å¼€å§‹åŠ è½½è½¯ä»¶è¯¦æƒ…ï¼ŒID:', id);

    try {
      const response = await apiClient.getSoftwareById(parseInt(id));
      console.log('APIå“åº”:', response);

      if (response.success && response.data) {
        softwareData = response.data;
        renderSoftwareDetails(softwareData);
        
        // æ˜¾ç¤ºå…¶ä»–éƒ¨åˆ†
        document.getElementById('versions-section').style.display = 'block';
        document.getElementById('announcements-section').style.display = 'block';
        
        // åŠ è½½ç‰ˆæœ¬å†å²å’Œå…¬å‘Š
        loadVersions();
        loadAnnouncements();
      } else {
        throw new Error(response.message || 'è½¯ä»¶ä¸å­˜åœ¨');
      }
    } catch (error) {
      console.error('åŠ è½½è½¯ä»¶è¯¦æƒ…å¤±è´¥:', error);
      container.innerHTML = `
        <div class="text-center py-12">
          <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">åŠ è½½å¤±è´¥</h3>
          <p class="text-gray-500 mb-4">${error.message || 'æ— æ³•åŠ è½½è½¯ä»¶ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•'}</p>
          <div class="space-x-4">
            <button onclick="loadSoftwareDetails(id)" class="btn btn-primary">
              é‡æ–°åŠ è½½
            </button>
            <a href="/" class="btn btn-outline">
              è¿”å›é¦–é¡µ
            </a>
          </div>
        </div>
      `;
    }
  }

  // æ¸²æŸ“è½¯ä»¶è¯¦æƒ…
  function renderSoftwareDetails(software) {
    console.log('å¼€å§‹æ¸²æŸ“è½¯ä»¶è¯¦æƒ…:', software);
    const container = document.getElementById('software-container');
    if (!container) {
      console.error('è½¯ä»¶å®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
      return;
    }

    const downloadUrl = software.latestDownloadUrl || getPriorityDownloadLink(software.versions?.[0]?.downloadLinks);
    const systemReqs = software.systemRequirements;
    console.log('ä¸‹è½½é“¾æ¥:', downloadUrl);
    console.log('ç³»ç»Ÿè¦æ±‚:', systemReqs);

    container.innerHTML = `
      <!-- é¢åŒ…å±‘å¯¼èˆª -->
      <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-6">
        <a href="/" class="hover:text-gray-700">é¦–é¡µ</a>
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        ${software.category ? `
          <a href="/categories/${software.category}" class="hover:text-gray-700">${software.category}</a>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
        ` : ''}
        <span class="text-gray-900">${software.name}</span>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- ä¸»è¦ä¿¡æ¯ -->
        <div class="lg:col-span-2">
          <!-- è½¯ä»¶æ ‡é¢˜ -->
          <div class="mb-6">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">${software.name}</h1>
                ${software.nameEn ? `<p class="text-lg text-gray-600">${software.nameEn}</p>` : ''}
              </div>
              <div class="flex flex-col items-end space-y-2">
                <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-primary-100 text-primary-800">
                  v${software.currentVersion}
                </span>
                ${software.category ? `
                  <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-gray-100 text-gray-800">
                    ${software.category}
                  </span>
                ` : ''}
              </div>
            </div>

            <!-- æ ‡ç­¾ -->
            ${software.tags && software.tags.length > 0 ? `
              <div class="flex flex-wrap gap-2 mb-4">
                ${software.tags.map(tag => `
                  <a href="/tags/${encodeURIComponent(tag)}" 
                     class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
                    ${tag}
                  </a>
                `).join('')}
              </div>
            ` : ''}

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex items-center space-x-4">
              ${downloadUrl ? `
                <button
                  id="main-download-button"
                  class="btn btn-primary btn-lg bg-orange-500 hover:bg-orange-600"
                  data-download-url="${downloadUrl}"
                  data-show-login-prompt="true"
                  type="button">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <span class="download-text hidden">ç«‹å³ä¸‹è½½</span>
                  <span class="login-prompt-text">è¯·ç™»å½•åä¸‹è½½</span>
                </button>
              ` : ''}
              
              ${software.officialWebsite ? `
                <a href="${software.officialWebsite}" target="_blank" rel="noopener noreferrer" 
                   class="btn btn-outline">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                  å®˜æ–¹ç½‘ç«™
                </a>
              ` : ''}
            </div>
          </div>

          <!-- è½¯ä»¶æè¿° -->
          <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">è½¯ä»¶ä»‹ç»</h3>
            <div class="prose prose-sm max-w-none text-gray-600">
              <p>${software.description || 'æš‚æ— æè¿°'}</p>
              ${software.descriptionEn ? `<p class="mt-3 text-gray-500">${software.descriptionEn}</p>` : ''}
            </div>
          </div>

          <!-- ç³»ç»Ÿè¦æ±‚ -->
          ${systemReqs ? `
            <div class="bg-white rounded-lg border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-3">ç³»ç»Ÿè¦æ±‚</h3>
              <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                ${systemReqs.os ? `
                  <div>
                    <dt class="text-sm font-medium text-gray-500">æ“ä½œç³»ç»Ÿ</dt>
                    <dd class="mt-1 text-sm text-gray-900">${Array.isArray(systemReqs.os) ? systemReqs.os.join(', ') : systemReqs.os}</dd>
                  </div>
                ` : ''}
                ${systemReqs.memory ? `
                  <div>
                    <dt class="text-sm font-medium text-gray-500">å†…å­˜è¦æ±‚</dt>
                    <dd class="mt-1 text-sm text-gray-900">${systemReqs.memory}</dd>
                  </div>
                ` : ''}
                ${systemReqs.storage ? `
                  <div>
                    <dt class="text-sm font-medium text-gray-500">å­˜å‚¨ç©ºé—´</dt>
                    <dd class="mt-1 text-sm text-gray-900">${systemReqs.storage}</dd>
                  </div>
                ` : ''}
              </dl>
            </div>
          ` : ''}
        </div>

        <!-- ä¾§è¾¹æ ä¿¡æ¯ -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg border border-gray-200 p-6 sticky top-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">è½¯ä»¶ä¿¡æ¯</h3>
            <dl class="space-y-3">
              <div>
                <dt class="text-sm font-medium text-gray-500">å½“å‰ç‰ˆæœ¬</dt>
                <dd class="mt-1 text-sm text-gray-900">v${software.currentVersion}</dd>
              </div>

              ${software.viewCount !== undefined ? `
                <div>
                  <dt class="text-sm font-medium text-gray-500">æµè§ˆé‡</dt>
                  <dd class="mt-1 text-sm text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    ${software.viewCount.toLocaleString()} æ¬¡
                  </dd>
                </div>
              ` : ''}

              ${software.rank ? `
                <div>
                  <dt class="text-sm font-medium text-gray-500">çƒ­é—¨æ’å</dt>
                  <dd class="mt-1 text-sm text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-1 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    ç¬¬ ${software.rank} å
                  </dd>
                </div>
              ` : ''}

              ${software.filetype ? `
                <div>
                  <dt class="text-sm font-medium text-gray-500">æ–‡ä»¶æ ¼å¼</dt>
                  <dd class="mt-1 text-sm text-gray-900">${software.filetype.toUpperCase()}</dd>
                </div>
              ` : ''}

              ${software.openname ? `
                <div>
                  <dt class="text-sm font-medium text-gray-500">å¯åŠ¨æ–‡ä»¶</dt>
                  <dd class="mt-1 text-sm text-gray-900 font-mono">${software.openname}</dd>
                </div>
              ` : ''}

              <div>
                <dt class="text-sm font-medium text-gray-500">æœ€åæ›´æ–°</dt>
                <dd class="mt-1 text-sm text-gray-900">${formatDate(software.updatedAt)}</dd>
              </div>

              <div>
                <dt class="text-sm font-medium text-gray-500">æ·»åŠ æ—¶é—´</dt>
                <dd class="mt-1 text-sm text-gray-900">${formatDate(software.createdAt)}</dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
    `;

    // æ›´æ–°é¡µé¢æ ‡é¢˜
    document.title = `${software.name} - APPFUN`;
    
    // åˆå§‹åŒ–ä¸‹è½½æŒ‰é’®
    initializeDownloadButtons();
  }

  // åŠ è½½ç‰ˆæœ¬å†å²
  async function loadVersions() {
    const container = document.getElementById('versions-container');
    if (!container || !softwareData) return;

    container.innerHTML = `
      <div class="flex justify-center py-8">
        <div class="animate-spin w-6 h-6 border-2 border-primary-600 border-t-transparent rounded-full"></div>
      </div>
    `;

    try {
      const params = {
        page: 1,
        limit: 10,
        sortBy: 'releaseDate',
        sortOrder: 'desc'
      };

      if (currentVersionFilter !== 'all') {
        params.versionType = currentVersionFilter;
      }

      const response = await apiClient.getSoftwareVersions(softwareData.id, params);

      if (response.success && response.data) {
        const versions = response.data.versions || response.data;
        
        if (versions.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8">
              <p class="text-gray-500">æš‚æ— ç‰ˆæœ¬å†å²</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="space-y-4">
            ${versions.map(version => `
              <div class="bg-white rounded-lg border border-gray-200 p-6">
                <div class="flex items-start justify-between mb-3">
                  <div>
                    <h4 class="text-lg font-semibold text-gray-900">v${version.version}</h4>
                    <p class="text-sm text-gray-500">${formatDate(version.releaseDate)}</p>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
    version.versionType === 'release' ? 'bg-green-100 text-green-800' :
      version.versionType === 'beta' ? 'bg-yellow-100 text-yellow-800' :
        'bg-red-100 text-red-800'
  }">
                      ${version.versionType === 'release' ? 'æ­£å¼ç‰ˆ' : 
      version.versionType === 'beta' ? 'æµ‹è¯•ç‰ˆ' : 'å†…æµ‹ç‰ˆ'}
                    </span>
                    ${version.isStable ? `
                      <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-blue-100 text-blue-800">
                        ç¨³å®šç‰ˆ
                      </span>
                    ` : ''}
                  </div>
                </div>
                
                ${version.releaseNotes ? `
                  <div class="mb-4">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">æ›´æ–°å†…å®¹</h5>
                    <p class="text-sm text-gray-600">${version.releaseNotes}</p>
                  </div>
                ` : ''}
                
              </div>
            `).join('')}
          </div>
        `;
      }
    } catch (error) {
      console.error('åŠ è½½ç‰ˆæœ¬å†å²å¤±è´¥:', error);
      container.innerHTML = `
        <div class="text-center py-8">
          <p class="text-red-600">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
        </div>
      `;
    }
  }

  // åŠ è½½å…¬å‘Š
  async function loadAnnouncements() {
    const container = document.getElementById('announcements-container');
    if (!container || !softwareData) return;

    try {
      const response = await apiClient.getSoftwareAnnouncements(softwareData.id, {
        page: 1,
        limit: 5,
        isPublished: true,
        sortBy: 'publishedAt',
        sortOrder: 'desc'
      });

      if (response.success && response.data) {
        const announcements = response.data.announcements || response.data;
        
        if (announcements.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8">
              <p class="text-gray-500">æš‚æ— ç›¸å…³å…¬å‘Š</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="space-y-4">
            ${announcements.map(announcement => `
              <div class="bg-white rounded-lg border border-gray-200 p-6">
                <div class="flex items-start justify-between mb-3">
                  <h4 class="text-lg font-semibold text-gray-900">${announcement.title}</h4>
                  <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
    announcement.type === 'security' ? 'bg-red-100 text-red-800' :
      announcement.type === 'update' ? 'bg-green-100 text-green-800' :
        announcement.type === 'maintenance' ? 'bg-yellow-100 text-yellow-800' :
          'bg-blue-100 text-blue-800'
  }">
                      ${announcement.type === 'security' ? 'å®‰å…¨å…¬å‘Š' :
      announcement.type === 'update' ? 'æ›´æ–°é€šçŸ¥' :
        announcement.type === 'maintenance' ? 'ç»´æŠ¤é€šçŸ¥' :
          announcement.type === 'feature' ? 'åŠŸèƒ½ä»‹ç»' :
            announcement.type === 'bugfix' ? 'ä¿®å¤é€šçŸ¥' : 'ä¸€èˆ¬å…¬å‘Š'}
                    </span>
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
    announcement.priority === 'urgent' ? 'bg-red-100 text-red-800' :
      announcement.priority === 'high' ? 'bg-orange-100 text-orange-800' :
        announcement.priority === 'normal' ? 'bg-blue-100 text-blue-800' :
          'bg-gray-100 text-gray-800'
  }">
                      ${announcement.priority === 'urgent' ? 'ç´§æ€¥' :
      announcement.priority === 'high' ? 'é«˜' :
        announcement.priority === 'normal' ? 'æ™®é€š' : 'ä½'}
                    </span>
                  </div>
                </div>
                
                <p class="text-sm text-gray-600 mb-3">${announcement.content}</p>
                
                <div class="flex items-center justify-between text-xs text-gray-500">
                  <span>${formatDate(announcement.publishedAt)}</span>
                  ${announcement.version ? `<span>ç‰ˆæœ¬: v${announcement.version}</span>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
    } catch (error) {
      console.error('åŠ è½½å…¬å‘Šå¤±è´¥:', error);
      container.innerHTML = `
        <div class="text-center py-8">
          <p class="text-red-600">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
        </div>
      `;
    }
  }

  // åˆå§‹åŒ–ä¸‹è½½æŒ‰é’®
  function initializeDownloadButtons() {
    // ç›´æ¥åˆå§‹åŒ–ï¼Œä¸å†ä¾èµ–authManager
    initDownloadButtonsWithModules();
    
    // ç¡®ä¿ä¸»ä¸‹è½½æŒ‰é’®æ­£ç¡®åˆå§‹åŒ–
    const mainDownloadButton = document.getElementById('main-download-button');
    if (mainDownloadButton) {
      // ç«‹å³æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶æ›´æ–°æŒ‰é’®
      checkGlobalLoginStatus().then(() => {
        const isLoggedIn = globalLoginState;
        const downloadText = mainDownloadButton.querySelector('.download-text');
        const loginPromptText = mainDownloadButton.querySelector('.login-prompt-text');
        
        if (isLoggedIn) {
          // å·²ç™»å½•çŠ¶æ€ - æ˜¾ç¤º"ç«‹å³ä¸‹è½½"
          mainDownloadButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
          mainDownloadButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
          
          if (downloadText && loginPromptText) {
            downloadText.classList.remove('hidden');
            loginPromptText.classList.add('hidden');
          }
        } else {
          // æœªç™»å½•çŠ¶æ€ - æ˜¾ç¤º"è¯·ç™»å½•åä¸‹è½½"
          mainDownloadButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
          mainDownloadButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
          
          if (downloadText && loginPromptText) {
            downloadText.classList.add('hidden');
            loginPromptText.classList.remove('hidden');
          }
        }
      });
    }
  }

  function initDownloadButtonsWithModules() {
    // ä¸‹è½½æŒ‰é’®ç®¡ç†å™¨ç±»
    class DownloadButtonManager {
      constructor(button) {
        this.button = button;
        this.downloadUrl = button.dataset.downloadUrl || '';
        this.downloadText = button.querySelector('.download-text');
        this.loginPromptText = button.querySelector('.login-prompt-text');
        this.showLoginPrompt = button.dataset.showLoginPrompt === 'true';
        this.isLoggedIn = false;
        this.softwareData = null; // å­˜å‚¨è½¯ä»¶æ•°æ®

        this.init();
      }

      async init() {
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        this.button.addEventListener('click', (e) => this.handleClick(e));
        
        // è·å–è½¯ä»¶æ•°æ®
        await this.fetchSoftwareData();
        
        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        await this.checkAuthStatus();
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“ç”¨æˆ·ä»ç™»å½•é¡µé¢è¿”å›æ—¶æ›´æ–°çŠ¶æ€
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            this.checkAuthStatus();
          }
        });
        
        // å®šæœŸæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
        setInterval(() => {
          this.checkAuthStatus();
        }, 30000);
      }

      async fetchSoftwareData() {
        try {
          const apiClient = new ApiClient(apiConfig);
          const response = await apiClient.getSoftwareById(parseInt(id));
          
          if (response.success && response.data) {
            this.softwareData = response.data;
            
            // è·å–æœ€æ–°ç‰ˆæœ¬çš„ä¸‹è½½é“¾æ¥
            if (this.softwareData.versions && this.softwareData.versions.length > 0) {
              // æŒ‰å‘å¸ƒæ—¥æœŸæ’åºï¼Œè·å–æœ€æ–°ç‰ˆæœ¬
              const sortedVersions = [...this.softwareData.versions].sort((a, b) => 
                new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
              );
              const latestVersion = sortedVersions[0];
              
              if (latestVersion.downloadLinks) {
                const priorityLink = getPriorityDownloadLink(latestVersion.downloadLinks);
                if (priorityLink) {
                  this.downloadUrl = priorityLink;
                }
              }
            } else if (this.softwareData.latestDownloadUrl) {
              // å¦‚æœæ²¡æœ‰ç‰ˆæœ¬åˆ—è¡¨ä½†æœ‰æœ€æ–°ä¸‹è½½é“¾æ¥ï¼Œä½¿ç”¨å®ƒ
              this.downloadUrl = this.softwareData.latestDownloadUrl;
            }
          }
        } catch (error) {
          console.error('è·å–è½¯ä»¶æ•°æ®å¤±è´¥:', error);
        }
      }

      // è·å–è½¯ä»¶ç‰ˆæœ¬è¯¦æƒ…APIè°ƒç”¨
      async fetchSoftwareVersions() {
        try {
          const apiClient = new ApiClient(apiConfig);
          const response = await apiClient.getSoftwareVersions(parseInt(id), {
            page: 1,
            limit: 10,
            sortBy: 'releaseDate',
            sortOrder: 'desc'
          });
          
          if (response.success && response.data && response.data.length > 0) {
            // è¿”å›æŒ‰å‘å¸ƒæ—¥æœŸæ’åºçš„ç‰ˆæœ¬åˆ—è¡¨
            return response.data.sort((a, b) => 
              new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
            );
          }
          return [];
        } catch (error) {
          console.error('è·å–è½¯ä»¶ç‰ˆæœ¬å¤±è´¥:', error);
          return [];
        }
      }

      async checkAuthStatus() {
        try {
          // ä½¿ç”¨å…¨å±€ç™»å½•çŠ¶æ€æ£€æŸ¥å‡½æ•°
          await checkGlobalLoginStatus();
          this.isLoggedIn = globalLoginState;
          this.updateButtonState();
        } catch (error) {
          console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
          this.isLoggedIn = false;
          this.updateButtonState();
        }
      }

      async checkAuthStatusWithFetch() {
        try {
          const response = await fetch('/api/auth/status');
          if (response.ok) {
            const data = await response.json();
            this.isLoggedIn = !!data.user;
          } else {
            this.isLoggedIn = false;
          }
        } catch (error) {
          console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
          this.isLoggedIn = false;
        }
      }

      updateButtonState() {
        if (this.showLoginPrompt) {
          // æ ¹æ®ç™»å½•çŠ¶æ€æ›´æ–°æŒ‰é’®çŠ¶æ€
          if (this.isLoggedIn) {
            // å·²ç™»å½•çŠ¶æ€ - æ˜¾ç¤º"ç«‹å³ä¸‹è½½"
            this.button.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            this.button.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            if (this.downloadText && this.loginPromptText) {
              this.downloadText.classList.remove('hidden');
              this.loginPromptText.classList.add('hidden');
            }
          } else {
            // æœªç™»å½•çŠ¶æ€ - æ˜¾ç¤º"è¯·ç™»å½•åä¸‹è½½"
            this.button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            this.button.classList.add('bg-orange-500', 'hover:bg-orange-600');
            
            if (this.downloadText && this.loginPromptText) {
              this.downloadText.classList.add('hidden');
              this.loginPromptText.classList.remove('hidden');
            }
          }
        } else {
          // å¦‚æœä¸éœ€è¦ç™»å½•æç¤ºï¼Œä¿æŒé»˜è®¤çŠ¶æ€
          this.button.classList.add('bg-blue-600', 'hover:bg-blue-700');
          
          if (this.downloadText && this.loginPromptText) {
            this.downloadText.classList.remove('hidden');
            this.loginPromptText.classList.add('hidden');
          }
        }
        
        this.button.disabled = false;
      }

      handleClick(event) {
        event.preventDefault();
        
        if (this.showLoginPrompt && !this.isLoggedIn) {
          // æœªç™»å½•æ—¶è·³è½¬åˆ°ç™»å½•é¡µé¢
          window.location.href = '/auth/login';
        } else {
          // å·²ç™»å½•æ—¶æ˜¾ç¤ºä¸‹è½½å¼¹çª—
          this.showDownloadModal();
        }
      }

      async showDownloadModal() {
        // åˆ›å»ºå¼¹çª—
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        };
        
        // å¼¹çª—å†…å®¹
        const modalContent = document.createElement('div');
        modalContent.className = 'bg-white rounded-lg shadow-xl max-w-md w-full p-6';
        
        // å¼¹çª—å¤´éƒ¨
        const modalHeader = document.createElement('div');
        modalHeader.className = 'flex justify-between items-center mb-4';
        
        const title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-gray-900';
        title.textContent = 'ä¸‹è½½è½¯ä»¶';
        
        const closeButton = document.createElement('button');
        closeButton.className = 'text-gray-500 hover:text-gray-700';
        closeButton.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        closeButton.onclick = () => modal.remove();
        
        modalHeader.appendChild(title);
        modalHeader.appendChild(closeButton);
        
        // å¼¹çª—å†…å®¹
        const modalBody = document.createElement('div');
        modalBody.className = 'mb-4';
        
        // è½¯ä»¶ä¿¡æ¯
        if (this.softwareData) {
          const softwareName = document.createElement('h4');
          softwareName.className = 'text-md font-medium text-gray-900 mb-2';
          softwareName.textContent = this.softwareData.name || 'è½¯ä»¶';
          modalBody.appendChild(softwareName);
          
          // ç‰ˆæœ¬ä¿¡æ¯
          const versionInfo = document.createElement('p');
          versionInfo.className = 'text-sm text-gray-600 mb-3';
          
          // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
          versionInfo.textContent = 'æ­£åœ¨è·å–ä¸‹è½½é“¾æ¥...';
          modalBody.appendChild(versionInfo);
          
          // ä¸‹è½½é“¾æ¥é€‰é¡¹å®¹å™¨
          const linksContainer = document.createElement('div');
          linksContainer.className = 'grid grid-cols-1 gap-2 mb-4 hidden';
          modalBody.appendChild(linksContainer);
          
          // å½“å‰é€‰ä¸­çš„é“¾æ¥ - ç§»åˆ°try-catchå¤–éƒ¨ï¼Œç¡®ä¿æ•´ä¸ªæ–¹æ³•éƒ½èƒ½è®¿é—®
          let selectedLink = this.downloadUrl;
          
          try {
            // è°ƒç”¨ç‰ˆæœ¬APIè·å–å®Œæ•´çš„ç‰ˆæœ¬ä¿¡æ¯
            const versions = await this.fetchSoftwareVersions();
            let latestVersion = this.softwareData.currentVersion;
            let downloadLinks = {};
            
            if (versions && versions.length > 0) {
              // ä½¿ç”¨APIè¿”å›çš„æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
              const latestVersionData = versions[0];
              latestVersion = latestVersionData.version;
              
              // è·å–APIè¿”å›çš„å®Œæ•´ä¸‹è½½é“¾æ¥
              if (latestVersionData.downloadLinks) {
                downloadLinks = latestVersionData.downloadLinks;
              }
            } else if (this.softwareData.versions && this.softwareData.versions.length > 0) {
              // é™çº§ä½¿ç”¨è½¯ä»¶è¯¦æƒ…ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
              const sortedVersions = [...this.softwareData.versions].sort((a, b) => 
                new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
              );
              latestVersion = sortedVersions[0].version;
              
              if (sortedVersions[0].downloadLinks) {
                downloadLinks = sortedVersions[0].downloadLinks;
              }
            }
            
            // æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º
            versionInfo.textContent = `æœ€æ–°ç‰ˆæœ¬: v${latestVersion || 'æœªçŸ¥'}`;
            
            // æ›´æ–°æ—¶é—´
            if (this.softwareData.updatedAt) {
              const releaseDate = document.createElement('p');
              releaseDate.className = 'text-xs text-gray-500 mb-3';
              releaseDate.textContent = `æ›´æ–°æ—¶é—´: ${formatDate(this.softwareData.updatedAt)}`;
              modalBody.insertBefore(releaseDate, versionInfo.nextSibling);
            }
            
            // ä¸‹è½½é“¾æ¥é€‰æ‹©æ ‡ç­¾
            const linksLabel = document.createElement('p');
            linksLabel.className = 'text-gray-700 mb-2 font-medium';
            linksLabel.textContent = 'é€‰æ‹©ä¸‹è½½æ¸ é“:';
            modalBody.insertBefore(linksLabel, linksContainer);
            
            // ä¸‹è½½æ¸ é“é…ç½®ï¼Œä½¿ç”¨æ›´ç›´è§‚çš„å›¾æ ‡å’Œé¢œè‰²æ ‡è¯†ï¼Œå¢åŠ URLåŒ¹é…è§„åˆ™å’Œä¼˜å…ˆçº§
            const linkTypes = {
              official: { name: 'å®˜æ–¹ä¸‹è½½', icon: 'ğŸ¢', color: 'bg-blue-100 border-blue-200', priority: 1 },
              baidu: { name: 'ç™¾åº¦ç½‘ç›˜', icon: 'ğŸ“', color: 'bg-blue-50 border-blue-100', regex: /pan\.baidu\.com/, priority: 2 },
              quark: { name: 'å¤¸å…‹ç½‘ç›˜', icon: 'âš¡', color: 'bg-purple-50 border-purple-100', regex: /pan\.quark\.cn/, priority: 3 },
              thunderPan: { name: 'è¿…é›·ç½‘ç›˜', icon: 'ğŸ’¨', color: 'bg-orange-50 border-orange-100', regex: /kuai\.xunlei\.com/, priority: 4 },
              pan123: { name: '123ç½‘ç›˜', icon: 'ğŸ”—', color: 'bg-green-50 border-green-100', regex: /123pan\.com/, priority: 5 },
              github: { name: 'GitHub', icon: 'ğŸ™', color: 'bg-gray-50 border-gray-200', regex: /github\.com/, priority: 6 },
              thunder: { name: 'è¿…é›·', icon: 'âš¡', color: 'bg-red-50 border-red-100', regex: /thunder:|xunlei:/, priority: 7 }
            };
              
              // åˆå¹¶ç›´æ¥çš„downloadUrlåˆ°downloadLinkså¯¹è±¡
              if (this.downloadUrl && !Object.values(downloadLinks).some(link => link === this.downloadUrl || 
                  (Array.isArray(link) && link.includes(this.downloadUrl)))) {
                // è‡ªåŠ¨è¯†åˆ«é“¾æ¥ç±»å‹
                let matchedType = 'official'; // é»˜è®¤ç±»å‹
                let highestPriorityMatch = Infinity;
                
                Object.entries(linkTypes).forEach(([key, { regex, priority }]) => {
                  if (regex && regex.test(this.downloadUrl) && priority < highestPriorityMatch) {
                    matchedType = key;
                    highestPriorityMatch = priority;
                  }
                });
                
                // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å…·ä½“ç±»å‹ï¼Œä½¿ç”¨å®˜æ–¹ä¸‹è½½
                downloadLinks[matchedType] = this.downloadUrl;
              }
              
              // æŒ‰ä¼˜å…ˆçº§æ’åºä¸‹è½½æ¸ é“
              const sortedLinkTypes = Object.entries(linkTypes).sort((a, b) => a[1].priority - b[1].priority);
              
              // åˆ›å»ºé“¾æ¥é€‰é¡¹ - æ”¹ä¸ºæŒ‰é’®å½¢å¼
              sortedLinkTypes.forEach(([key, { name, icon, color }]) => {
                if (downloadLinks[key] && downloadLinks[key].trim()) {
                  // å¤„ç†å¯èƒ½æ˜¯æ•°ç»„çš„å¤‡ä»½é“¾æ¥
                  const links = Array.isArray(downloadLinks[key]) ? downloadLinks[key] : [downloadLinks[key]];
                  
                  links.forEach((link, index) => {
                    if (link && link.trim()) {
                      const linkButton = document.createElement('button');
                      linkButton.className = `flex items-center p-3 border rounded-md cursor-pointer hover:bg-gray-50 transition-all duration-200 ${color} w-full justify-between text-left mb-2`;
                      linkButton.title = `ç‚¹å‡»è·³è½¬åˆ°${name}`;
                      
                      // æ·»åŠ æ‚¬åœåŠ¨ç”»æ•ˆæœ
                      linkButton.style.transform = 'scale(1)';
                      linkButton.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
                      linkButton.addEventListener('mouseenter', () => {
                        linkButton.style.transform = 'scale(1.01)';
                        linkButton.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                      });
                      linkButton.addEventListener('mouseleave', () => {
                        linkButton.style.transform = 'scale(1)';
                        linkButton.style.boxShadow = 'none';
                      });
                      
                      // ç‚¹å‡»äº‹ä»¶ - ç›´æ¥åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
                      linkButton.onclick = () => {
                        window.open(link, '_blank', 'noopener,noreferrer');
                        
                        // è§¦å‘ä¸‹è½½äº‹ä»¶
                        window.dispatchEvent(new CustomEvent('downloadStarted', {
                          detail: { url: link }
                        }));
                      };
                      
                      const linkName = document.createElement('div');
                      linkName.className = 'flex items-center';
                      linkName.innerHTML = `<span class="mr-2">${icon}</span>${name}${links.length > 1 ? ` <span class="text-xs bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded-full">å¤‡ç”¨${index + 1}</span>` : ''}`;
                      
                      const openIcon = document.createElement('span');
                      openIcon.className = 'ml-auto text-gray-400';
                      openIcon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>';
                      
                      linkButton.appendChild(linkName);
                      linkButton.appendChild(openIcon);
                      
                      linksContainer.appendChild(linkButton);
                    }
                  });
                }
              });
          
          // æ˜¾ç¤ºé“¾æ¥å®¹å™¨
          linksContainer.classList.remove('hidden');
          
          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä¸‹è½½é“¾æ¥ï¼Œæ˜¾ç¤ºé»˜è®¤é“¾æ¥
          if (linksContainer.children.length === 0 && this.downloadUrl) {
            const defaultLinkButton = document.createElement('button');
            defaultLinkButton.className = 'flex items-center p-3 border rounded-md cursor-pointer hover:bg-gray-50 transition-colors bg-gray-50 w-full justify-between text-left mb-2';
            defaultLinkButton.title = 'ç‚¹å‡»è·³è½¬åˆ°é»˜è®¤ä¸‹è½½é“¾æ¥';
            
            // æ·»åŠ æ‚¬åœåŠ¨ç”»æ•ˆæœ
            defaultLinkButton.style.transform = 'scale(1)';
            defaultLinkButton.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
            defaultLinkButton.addEventListener('mouseenter', () => {
              defaultLinkButton.style.transform = 'scale(1.01)';
              defaultLinkButton.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
            });
            defaultLinkButton.addEventListener('mouseleave', () => {
              defaultLinkButton.style.transform = 'scale(1)';
              defaultLinkButton.style.boxShadow = 'none';
            });
            
            // ç‚¹å‡»äº‹ä»¶ - ç›´æ¥åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
            defaultLinkButton.onclick = () => {
              window.open(this.downloadUrl, '_blank', 'noopener,noreferrer');
              
              // è§¦å‘ä¸‹è½½äº‹ä»¶
              window.dispatchEvent(new CustomEvent('downloadStarted', {
                detail: { url: this.downloadUrl }
              }));
            };
            
            const linkName = document.createElement('div');
            linkName.className = 'flex items-center';
            linkName.innerHTML = '<span class="mr-2">ğŸ“¥</span>é»˜è®¤ä¸‹è½½';
            
            const openIcon = document.createElement('span');
            openIcon.className = 'ml-auto text-gray-400';
            openIcon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>';
            
            defaultLinkButton.appendChild(linkName);
            defaultLinkButton.appendChild(openIcon);
            
            linksContainer.appendChild(defaultLinkButton);
          }
          
          // å¤„ç†æ— é“¾æ¥æƒ…å†µ
          if (linksContainer.children.length === 0 && !this.downloadUrl) {
            const noLinkMessage = document.createElement('p');
            noLinkMessage.className = 'text-gray-500 text-center p-4 bg-gray-50 rounded-md';
            noLinkMessage.textContent = 'æš‚æ— å¯ä¸‹è½½é“¾æ¥';
            linksContainer.appendChild(noLinkMessage);
          }
        } catch (error) {
          console.error('è·å–ä¸‹è½½é“¾æ¥å¤±è´¥:', error);
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          const errorMessage = document.createElement('p');
          errorMessage.className = 'text-red-500 text-sm mt-2';
          errorMessage.textContent = 'è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
          modalBody.appendChild(errorMessage);
          
          // é™çº§ä½¿ç”¨åŸæœ‰æ•°æ®
          if (this.softwareData.versions && this.softwareData.versions.length > 0) {
            // æŒ‰å‘å¸ƒæ—¥æœŸæ’åºï¼Œè·å–æœ€æ–°ç‰ˆæœ¬
            const sortedVersions = [...this.softwareData.versions].sort((a, b) => 
              new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
            );
            const latestVersion = sortedVersions[0].version;
            versionInfo.textContent = `æœ€æ–°ç‰ˆæœ¬: v${latestVersion || 'æœªçŸ¥'}`;
            
            // æ˜¾ç¤ºä¸‹è½½é“¾æ¥é€‰æ‹©åŒºåŸŸ
            linksContainer.classList.remove('hidden');
            
            // å¦‚æœæœ‰é™çº§å¯ç”¨çš„ä¸‹è½½é“¾æ¥ï¼Œæ˜¾ç¤ºå®ƒä»¬
                if (sortedVersions[0].downloadLinks) {
                  const downloadLinks = sortedVersions[0].downloadLinks;
                  // è¿™é‡Œå¯ä»¥å¤ç”¨ä¹‹å‰çš„é“¾æ¥åˆ›å»ºé€»è¾‘
                  // ä¸ºç®€åŒ–ï¼Œæˆ‘ä»¬ç›´æ¥æ˜¾ç¤ºé»˜è®¤é“¾æ¥
                  if (Object.values(downloadLinks).length > 0) {
                    const defaultLinkKey = Object.keys(downloadLinks)[0];
                    const defaultLink = downloadLinks[defaultLinkKey];
                    const defaultLinkButton = document.createElement('button');
                    defaultLinkButton.className = 'flex items-center p-3 border rounded-md cursor-pointer hover:bg-gray-50 transition-colors bg-gray-50 w-full justify-between text-left mb-2';
                    defaultLinkButton.title = 'ç‚¹å‡»è·³è½¬åˆ°ä¸‹è½½é“¾æ¥';
                    
                    // æ·»åŠ æ‚¬åœåŠ¨ç”»æ•ˆæœ
                    defaultLinkButton.style.transform = 'scale(1)';
                    defaultLinkButton.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
                    defaultLinkButton.addEventListener('mouseenter', () => {
                      defaultLinkButton.style.transform = 'scale(1.01)';
                      defaultLinkButton.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    });
                    defaultLinkButton.addEventListener('mouseleave', () => {
                      defaultLinkButton.style.transform = 'scale(1)';
                      defaultLinkButton.style.boxShadow = 'none';
                    });
                    
                    // ç‚¹å‡»äº‹ä»¶ - ç›´æ¥åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
                    defaultLinkButton.onclick = () => {
                      window.open(defaultLink, '_blank', 'noopener,noreferrer');
                      
                      // è§¦å‘ä¸‹è½½äº‹ä»¶
                      window.dispatchEvent(new CustomEvent('downloadStarted', {
                        detail: { url: defaultLink }
                      }));
                    };
                    
                    const linkName = document.createElement('div');
                    linkName.className = 'flex items-center';
                    linkName.innerHTML = `<span class="mr-2">ğŸ“¥</span>${defaultLinkKey === 'official' ? 'å®˜æ–¹ä¸‹è½½' : 'ä¸‹è½½é“¾æ¥'}`;
                    
                    const openIcon = document.createElement('span');
                    openIcon.className = 'ml-auto text-gray-400';
                    openIcon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>';
                    
                    defaultLinkButton.appendChild(linkName);
                    defaultLinkButton.appendChild(openIcon);
                    
                    linksContainer.appendChild(defaultLinkButton);
                  }
                }
          }
        }
        
        // å¼¹çª—åº•éƒ¨æŒ‰é’®
        const modalFooter = document.createElement('div');
        modalFooter.className = 'flex justify-center';
        
        const closeButton = document.createElement('button');
        closeButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors flex items-center justify-center';
        closeButton.textContent = 'å…³é—­';
        closeButton.onclick = () => modal.remove();
        
        modalFooter.appendChild(closeButton);
        
        // ç»„è£…å¼¹çª—
        modalContent.appendChild(modalHeader);
        modalContent.appendChild(modalBody);
        modalContent.appendChild(modalFooter);
        modal.appendChild(modalContent);
        
        // æ·»åŠ åˆ°æ–‡æ¡£
        document.body.appendChild(modal);
      }
      }
    }

    // åˆå§‹åŒ–æ‰€æœ‰ä¸‹è½½æŒ‰é’®
    const downloadButtons = document.querySelectorAll('[data-download-url]');
    downloadButtons.forEach(button => {
      new DownloadButtonManager(button);
    });

    // ä¸ºåŠ¨æ€æ·»åŠ çš„æŒ‰é’®æä¾›åˆå§‹åŒ–å‡½æ•°
    window.initializeDownloadButton = (button) => {
      new DownloadButtonManager(button);
    };
  }

  // å…¨å±€å‡½æ•°ï¼Œä¾›æŒ‰é’®è°ƒç”¨
  window.loadSoftwareDetails = (id) => loadSoftwareDetails(id);
</script>

<style>
  .bg-primary-100 {
    background-color: var(--color-primary-100);
  }
  
  .text-primary-800 {
    color: var(--color-primary-800);
  }
  
  .border-primary-600 {
    border-color: var(--color-primary-600);
  }
</style>
