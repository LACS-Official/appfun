---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="系统诊断 - APPFUN">
  <div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">系统诊断</h1>
        <p class="text-gray-600">诊断 Supabase 配置和认证问题</p>
      </div>
      
      <!-- Supabase 配置测试 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Supabase 配置测试</h2>
        
        <div class="mb-4">
          <button
            id="test-supabase-btn"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            测试 Supabase 配置
          </button>
        </div>
        
        <div id="supabase-results" class="hidden">
          <h3 class="text-lg font-medium text-gray-900 mb-2">测试结果</h3>
          <div id="supabase-results-content"></div>
        </div>
      </div>
      
      <!-- 登录测试 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">登录功能测试</h2>
        
        <div class="space-y-4 mb-4">
          <div>
            <label for="test-email" class="block text-sm font-medium text-gray-700 mb-2">
              测试邮箱
            </label>
            <input
              type="email"
              id="test-email"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="输入要测试的邮箱地址"
            />
          </div>
          
          <div>
            <label for="test-password" class="block text-sm font-medium text-gray-700 mb-2">
              测试密码
            </label>
            <input
              type="password"
              id="test-password"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="输入密码"
            />
          </div>
          
          <button
            id="test-login-btn"
            class="w-full px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            测试登录
          </button>
        </div>
        
        <div id="login-results" class="hidden">
          <h3 class="text-lg font-medium text-gray-900 mb-2">登录测试结果</h3>
          <div id="login-results-content"></div>
        </div>
      </div>
      
      <!-- 快速注册测试用户 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">创建测试用户</h2>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
          <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div class="text-yellow-800">
              <p class="font-medium">注意</p>
              <p class="text-sm">如果登录失败，可能是因为用户不存在。您可以先注册一个测试用户。</p>
            </div>
          </div>
        </div>
        
        <div class="text-center">
          <a
            href="/auth/sign-up"
            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
          >
            前往注册页面
            <svg class="ml-2 -mr-1 w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </a>
        </div>
      </div>
      
      <!-- 常见问题解决方案 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">常见问题解决方案</h2>
        
        <div class="space-y-4">
          <div class="border-l-4 border-red-400 pl-4">
            <h3 class="font-medium text-red-800">Invalid API key</h3>
            <p class="text-sm text-red-700 mt-1">
              检查 .env 文件中的 PUBLIC_SUPABASE_ANON_KEY 是否正确配置
            </p>
          </div>
          
          <div class="border-l-4 border-yellow-400 pl-4">
            <h3 class="font-medium text-yellow-800">Invalid login credentials</h3>
            <p class="text-sm text-yellow-700 mt-1">
              用户名或密码错误，或用户不存在。请先注册用户或检查凭据
            </p>
          </div>
          
          <div class="border-l-4 border-blue-400 pl-4">
            <h3 class="font-medium text-blue-800">Email not confirmed</h3>
            <p class="text-sm text-blue-700 mt-1">
              邮箱未验证。检查邮箱或在 Supabase 控制台中手动确认用户
            </p>
          </div>
          
          <div class="border-l-4 border-green-400 pl-4">
            <h3 class="font-medium text-green-800">Auth session missing</h3>
            <p class="text-sm text-green-700 mt-1">
              认证会话丢失。这通常在页面刷新后发生，属于正常现象
            </p>
          </div>
        </div>
      </div>
      
      <!-- 返回链接 -->
      <div class="text-center">
        <a href="/" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
          ← 返回首页
        </a>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const testSupabaseBtn = document.getElementById('test-supabase-btn');
    const supabaseResults = document.getElementById('supabase-results');
    const supabaseResultsContent = document.getElementById('supabase-results-content');
    
    const testLoginBtn = document.getElementById('test-login-btn');
    const testEmailInput = document.getElementById('test-email');
    const testPasswordInput = document.getElementById('test-password');
    const loginResults = document.getElementById('login-results');
    const loginResultsContent = document.getElementById('login-results-content');
    
    // 测试 Supabase 配置
    testSupabaseBtn.addEventListener('click', async () => {
      testSupabaseBtn.disabled = true;
      testSupabaseBtn.textContent = '测试中...';
      
      try {
        const response = await fetch('/api/admin/test-supabase');
        const data = await response.json();
        
        supabaseResults.classList.remove('hidden');
        supabaseResultsContent.innerHTML = '';
        
        // 显示总体结果
        const summaryDiv = document.createElement('div');
        summaryDiv.className = `p-4 rounded-md mb-4 ${data.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
        summaryDiv.innerHTML = `
          <div class="flex items-center">
            <span class="${data.success ? 'text-green-800' : 'text-red-800'} font-medium">${data.message}</span>
          </div>
        `;
        supabaseResultsContent.appendChild(summaryDiv);
        
        // 显示详细结果
        if (data.results && data.results.length > 0) {
          const detailsDiv = document.createElement('div');
          detailsDiv.className = 'space-y-2';
          
          data.results.forEach(result => {
            const resultDiv = document.createElement('div');
            resultDiv.className = `p-3 rounded-md border ${
              result.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'
            }`;
            
            let content = `
              <div class="flex items-center justify-between">
                <span class="${result.success ? 'text-green-800' : 'text-red-800'} font-medium">${result.test}</span>
                <span class="${result.success ? 'text-green-600' : 'text-red-600'}">${result.success ? '✓' : '✗'}</span>
              </div>
            `;
            
            if (result.value) {
              content += `<div class="text-xs text-gray-600 mt-1">值: ${result.value}</div>`;
            }
            if (result.error) {
              content += `<div class="text-xs text-red-600 mt-1">错误: ${result.error}</div>`;
            }
            if (result.message) {
              content += `<div class="text-xs text-gray-600 mt-1">${result.message}</div>`;
            }
            
            resultDiv.innerHTML = content;
            detailsDiv.appendChild(resultDiv);
          });
          
          supabaseResultsContent.appendChild(detailsDiv);
        }
        
      } catch (error) {
        console.error('测试 Supabase 配置失败:', error);
        supabaseResults.classList.remove('hidden');
        supabaseResultsContent.innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded-md">
            <span class="text-red-800 font-medium">网络错误，请重试</span>
          </div>
        `;
      } finally {
        testSupabaseBtn.disabled = false;
        testSupabaseBtn.textContent = '测试 Supabase 配置';
      }
    });
    
    // 测试登录
    testLoginBtn.addEventListener('click', async () => {
      const email = testEmailInput.value.trim();
      const password = testPasswordInput.value.trim();
      
      if (!email || !password) {
        alert('请输入邮箱和密码');
        return;
      }
      
      testLoginBtn.disabled = true;
      testLoginBtn.textContent = '测试中...';
      
      try {
        const response = await fetch('/api/admin/test-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        loginResults.classList.remove('hidden');
        loginResultsContent.innerHTML = '';
        
        // 显示总体结果
        const summaryDiv = document.createElement('div');
        summaryDiv.className = `p-4 rounded-md mb-4 ${data.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
        summaryDiv.innerHTML = `
          <div class="flex items-center">
            <span class="${data.success ? 'text-green-800' : 'text-red-800'} font-medium">
              ${data.success ? '登录测试成功' : `登录测试失败: ${data.error}`}
            </span>
          </div>
        `;
        loginResultsContent.appendChild(summaryDiv);
        
        // 显示详细结果
        if (data.results && data.results.length > 0) {
          const detailsDiv = document.createElement('div');
          detailsDiv.className = 'space-y-2';
          
          data.results.forEach(result => {
            const resultDiv = document.createElement('div');
            resultDiv.className = `p-3 rounded-md border ${
              result.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'
            }`;
            
            let content = `
              <div class="flex items-center justify-between">
                <span class="${result.success ? 'text-green-800' : 'text-red-800'} font-medium">${result.step}</span>
                <span class="${result.success ? 'text-green-600' : 'text-red-600'}">${result.success ? '✓' : '✗'}</span>
              </div>
            `;
            
            if (result.error) {
              content += `<div class="text-xs text-red-600 mt-1">错误: ${result.error}</div>`;
            }
            if (result.message) {
              content += `<div class="text-xs text-gray-600 mt-1">${result.message}</div>`;
            }
            if (result.userId) {
              content += `<div class="text-xs text-gray-600 mt-1">用户ID: ${result.userId}</div>`;
            }
            
            resultDiv.innerHTML = content;
            detailsDiv.appendChild(resultDiv);
          });
          
          loginResultsContent.appendChild(detailsDiv);
        }
        
      } catch (error) {
        console.error('测试登录失败:', error);
        loginResults.classList.remove('hidden');
        loginResultsContent.innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded-md">
            <span class="text-red-800 font-medium">网络错误，请重试</span>
          </div>
        `;
      } finally {
        testLoginBtn.disabled = false;
        testLoginBtn.textContent = '测试登录';
      }
    });
    
    // 自动测试 Supabase 配置
    testSupabaseBtn.click();
  });
</script>
</Layout>
