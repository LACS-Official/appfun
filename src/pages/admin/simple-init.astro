---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="ç®€å•æ•°æ®åº“åˆå§‹åŒ– - APPFUN">
  <div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">æ•°æ®åº“åˆå§‹åŒ–</h1>
        <p class="text-gray-600">æ£€æŸ¥æ•°æ®åº“çŠ¶æ€å¹¶æä¾› SQL è„šæœ¬</p>
      </div>
      
      <!-- å½“å‰çŠ¶æ€ -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">å½“å‰ç³»ç»ŸçŠ¶æ€</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="text-center p-4 bg-blue-50 rounded-lg">
            <div class="text-2xl font-bold text-blue-600" id="db-status">æ£€æŸ¥ä¸­</div>
            <div class="text-sm text-gray-600">æ•°æ®åº“è¿æ¥</div>
          </div>
          
          <div class="text-center p-4 bg-green-50 rounded-lg">
            <div class="text-2xl font-bold text-green-600" id="table-status">æ£€æŸ¥ä¸­</div>
            <div class="text-sm text-gray-600">æ•°æ®è¡¨çŠ¶æ€</div>
          </div>
          
          <div class="text-center p-4 bg-purple-50 rounded-lg">
            <div class="text-2xl font-bold text-purple-600" id="api-status">æ£€æŸ¥ä¸­</div>
            <div class="text-sm text-gray-600">API åŠŸèƒ½</div>
          </div>
        </div>
        
        <div class="text-center">
          <button
            id="check-status-btn"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
          </button>
        </div>
      </div>
      
      <!-- åˆå§‹åŒ–æ“ä½œ -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">æ•°æ®åº“åˆå§‹åŒ–</h2>
        
        <div class="space-y-4">
          <div>
            <label for="admin-key" class="block text-sm font-medium text-gray-700 mb-2">
              ç®¡ç†å‘˜å¯†é’¥
            </label>
            <input
              type="password"
              id="admin-key"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥"
              value="admin-init-2024"
            />
          </div>
          
          <button
            id="init-btn"
            class="w-full px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®åº“
          </button>
        </div>
      </div>
      
      <!-- ç»“æœæ˜¾ç¤º -->
      <div id="results-section" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">æ“ä½œç»“æœ</h2>
        <div id="results-content"></div>
      </div>
      
      <!-- SQL è„šæœ¬ -->
      <div id="sql-section" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">SQL åˆå§‹åŒ–è„šæœ¬</h2>
        <p class="text-sm text-gray-600 mb-4">
          å¦‚æœè‡ªåŠ¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·å¤åˆ¶ä»¥ä¸‹ SQL è„šæœ¬åˆ° Supabase SQL ç¼–è¾‘å™¨ä¸­æ‰§è¡Œï¼š
        </p>
        
        <div class="relative">
          <pre id="sql-script" class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto text-sm font-mono max-h-96"></pre>
          <button
            id="copy-sql-btn"
            class="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600"
          >
            å¤åˆ¶
          </button>
        </div>
        
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <h3 class="font-medium text-blue-900 mb-2">æ‰§è¡Œæ­¥éª¤ï¼š</h3>
          <ol class="text-sm text-blue-800 space-y-1">
            <li>1. ç™»å½• Supabase æ§åˆ¶å°</li>
            <li>2. è¿›å…¥ SQL ç¼–è¾‘å™¨</li>
            <li>3. ç²˜è´´ä¸Šé¢çš„ SQL è„šæœ¬</li>
            <li>4. ç‚¹å‡»è¿è¡Œ</li>
            <li>5. åˆ·æ–°é¡µé¢æ£€æŸ¥çŠ¶æ€</li>
          </ol>
        </div>
      </div>
      
      <!-- æµ‹è¯•åŠŸèƒ½ -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">æµ‹è¯•åŠŸèƒ½</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <a
            href="/test-invitation"
            class="block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center"
          >
            <div class="text-2xl mb-2">ğŸ«</div>
            <h3 class="font-medium text-gray-900 mb-1">é‚€è¯·ç æµ‹è¯•</h3>
            <p class="text-sm text-gray-600">æµ‹è¯•é‚€è¯·ç åŠŸèƒ½</p>
          </a>
          
          <a
            href="/auth/sign-up"
            class="block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center"
          >
            <div class="text-2xl mb-2">ğŸ‘¤</div>
            <h3 class="font-medium text-gray-900 mb-1">ç”¨æˆ·æ³¨å†Œ</h3>
            <p class="text-sm text-gray-600">æµ‹è¯•æ³¨å†ŒåŠŸèƒ½</p>
          </a>
          
          <a
            href="/admin/invitations"
            class="block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center"
          >
            <div class="text-2xl mb-2">ğŸ“‹</div>
            <h3 class="font-medium text-gray-900 mb-1">é‚€è¯·ç ç®¡ç†</h3>
            <p class="text-sm text-gray-600">æŸ¥çœ‹é‚€è¯·ç åˆ—è¡¨</p>
          </a>
          
          <a
            href="/about"
            class="block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center"
          >
            <div class="text-2xl mb-2">ğŸ“Š</div>
            <h3 class="font-medium text-gray-900 mb-1">ç»Ÿè®¡æ•°æ®</h3>
            <p class="text-sm text-gray-600">æŸ¥çœ‹è®¿é—®ç»Ÿè®¡</p>
          </a>
        </div>
      </div>
      
      <!-- è¿”å›é“¾æ¥ -->
      <div class="mt-8 text-center">
        <a href="/" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
          â† è¿”å›é¦–é¡µ
        </a>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const checkStatusBtn = document.getElementById('check-status-btn');
    const initBtn = document.getElementById('init-btn');
    const adminKeyInput = document.getElementById('admin-key');
    const resultsSection = document.getElementById('results-section');
    const resultsContent = document.getElementById('results-content');
    const sqlSection = document.getElementById('sql-section');
    const sqlScript = document.getElementById('sql-script');
    const copySqlBtn = document.getElementById('copy-sql-btn');
    
    // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
    checkStatusBtn.addEventListener('click', checkSystemStatus);
    
    // åˆå§‹åŒ–æ•°æ®åº“
    initBtn.addEventListener('click', async () => {
      const adminKey = adminKeyInput.value.trim();
      
      if (!adminKey) {
        alert('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥');
        return;
      }
      
      initBtn.disabled = true;
      initBtn.textContent = 'æ£€æŸ¥ä¸­...';
      
      try {
        const response = await fetch('/api/admin/simple-init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminKey: adminKey }),
        });
        
        const data = await response.json();
        
        // æ˜¾ç¤ºç»“æœ
        resultsSection.classList.remove('hidden');
        resultsContent.innerHTML = '';
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        const messageDiv = document.createElement('div');
        messageDiv.className = `p-4 rounded-md mb-4 ${data.success ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}`;
        messageDiv.innerHTML = `
          <div class="flex items-center">
            <span class="${data.success ? 'text-green-800' : 'text-yellow-800'} font-medium">${data.message}</span>
          </div>
        `;
        resultsContent.appendChild(messageDiv);
        
        // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        if (data.results && data.results.length > 0) {
          const detailsDiv = document.createElement('div');
          detailsDiv.className = 'space-y-2';
          
          data.results.forEach(result => {
            const resultDiv = document.createElement('div');
            resultDiv.className = `flex items-center justify-between p-3 rounded-md ${
              result.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'
            }`;
            
            resultDiv.innerHTML = `
              <div>
                <span class="${result.success ? 'text-green-800' : 'text-red-800'}">${result.step}</span>
                ${result.message ? `<div class="text-xs text-gray-600 mt-1">${result.message}</div>` : ''}
                ${result.error ? `<div class="text-xs text-red-600 mt-1">${result.error}</div>` : ''}
              </div>
              <span class="${result.success ? 'text-green-600' : 'text-red-600'}">
                ${result.success ? 'âœ“' : 'âœ—'}
              </span>
            `;
            
            detailsDiv.appendChild(resultDiv);
          });
          
          resultsContent.appendChild(detailsDiv);
        }
        
        // æ˜¾ç¤º SQL è„šæœ¬
        if (data.sqlScript) {
          sqlSection.classList.remove('hidden');
          sqlScript.textContent = data.sqlScript;
        }
        
      } catch (error) {
        console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        resultsSection.classList.remove('hidden');
        resultsContent.innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded-md">
            <span class="text-red-800 font-medium">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</span>
          </div>
        `;
      } finally {
        initBtn.disabled = false;
        initBtn.textContent = 'æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®åº“';
      }
    });
    
    // å¤åˆ¶ SQL è„šæœ¬
    copySqlBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(sqlScript.textContent);
        copySqlBtn.textContent = 'å·²å¤åˆ¶';
        setTimeout(() => {
          copySqlBtn.textContent = 'å¤åˆ¶';
        }, 2000);
      } catch (error) {
        console.error('å¤åˆ¶å¤±è´¥:', error);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
      }
    });
    
    // åˆå§‹æ£€æŸ¥çŠ¶æ€
    checkSystemStatus();
  });
  
  async function checkSystemStatus() {
    const dbStatus = document.getElementById('db-status');
    const tableStatus = document.getElementById('table-status');
    const apiStatus = document.getElementById('api-status');
    
    // é‡ç½®çŠ¶æ€
    dbStatus.textContent = 'æ£€æŸ¥ä¸­';
    tableStatus.textContent = 'æ£€æŸ¥ä¸­';
    apiStatus.textContent = 'æ£€æŸ¥ä¸­';
    
    try {
      // æ£€æŸ¥æ•°æ®åº“è¿æ¥
      const dbResponse = await fetch('/api/admin/check-database');
      const dbData = await dbResponse.json();
      
      dbStatus.textContent = dbResponse.ok ? 'æ­£å¸¸' : 'å¼‚å¸¸';
      dbStatus.className = `text-2xl font-bold ${dbResponse.ok ? 'text-green-600' : 'text-red-600'}`;
      
      // æ£€æŸ¥è¡¨çŠ¶æ€
      const tableCount = dbData.results ? dbData.results.filter(r => r.success).length : 0;
      tableStatus.textContent = `${tableCount}/5`;
      tableStatus.className = `text-2xl font-bold ${tableCount >= 3 ? 'text-green-600' : 'text-yellow-600'}`;
      
      // æ£€æŸ¥ API åŠŸèƒ½
      const apiResponse = await fetch('/api/auth/validate-invitation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: 'TEST0001' })
      });
      
      apiStatus.textContent = apiResponse.ok ? 'æ­£å¸¸' : 'å¼‚å¸¸';
      apiStatus.className = `text-2xl font-bold ${apiResponse.ok ? 'text-green-600' : 'text-red-600'}`;
      
    } catch (error) {
      console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
      dbStatus.textContent = 'é”™è¯¯';
      tableStatus.textContent = 'é”™è¯¯';
      apiStatus.textContent = 'é”™è¯¯';
    }
  }
</script>
</Layout>
