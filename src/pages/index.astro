---
import Layout from '../layouts/Layout.astro';
import SoftwareCard from '../components/software/SoftwareCard.astro';
import LoadingSpinner from '../components/ui/LoadingSpinner.astro';
import ErrorMessage from '../components/ui/ErrorMessage.astro';
import Badge from '../components/ui/Badge.astro';
import { appConfig } from '../lib/config';
---

<Layout title="é¦–é¡µ" description="å‘ç°å’Œä¸‹è½½æœ€æ–°çš„è½¯ä»¶å·¥å…·">
  <!-- Hero Section -->
  <section class="bg-gradient-to-r from-primary-600 to-primary-700 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div class="text-center">
        <h1 class="text-4xl md:text-6xl font-bold mb-6">
          å‘ç°ä¼˜è´¨è½¯ä»¶
        </h1>
        <p class="text-xl md:text-2xl text-primary-100 mb-8 max-w-3xl mx-auto">
          æ¢ç´¢ã€ä¸‹è½½å’Œç®¡ç†å„ç§å®ç”¨çš„è½¯ä»¶å·¥å…·ï¼Œè®©æ‚¨çš„å·¥ä½œæ›´åŠ é«˜æ•ˆ
        </p>
        
        <!-- æœç´¢æ¡† -->
        <div class="max-w-2xl mx-auto">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <input
              type="text"
              placeholder="æœç´¢è½¯ä»¶åç§°ã€åˆ†ç±»æˆ–æ ‡ç­¾..."
              class="block w-full pl-10 pr-3 py-4 border border-transparent rounded-lg leading-5 bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-primary-600 text-lg"
              id="hero-search"
            />
          </div>
        </div>
        
        <!-- å¿«é€Ÿåˆ†ç±» -->
        <div class="mt-8 flex flex-wrap justify-center gap-3">
          <a href="/categories/tools" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-full text-sm font-medium transition-all">
            ğŸ”§ å·¥å…·è½¯ä»¶
          </a>
          <a href="/categories/development" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-full text-sm font-medium transition-all">
            ğŸ’» å¼€å‘å·¥å…·
          </a>
          <a href="/categories/design" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-full text-sm font-medium transition-all">
            ğŸ¨ è®¾è®¡è½¯ä»¶
          </a>
          <a href="/categories/multimedia" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-full text-sm font-medium transition-all">
            ğŸ¬ å¤šåª’ä½“
          </a>
        </div>
      </div>
    </div>
  </section>



  <!-- æœ€æ–°è½¯ä»¶ -->
  <section class="py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">æœ€æ–°è½¯ä»¶</h2>
          <p class="text-gray-600 mt-2">æœ€è¿‘æ›´æ–°çš„è½¯ä»¶å·¥å…·</p>
        </div>
        <a href="/software" class="btn btn-outline">
          æŸ¥çœ‹å…¨éƒ¨
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>

      <!-- è½¯ä»¶åˆ—è¡¨ -->
      <div id="latest-software-container">
        <div class="flex justify-center py-12">
          <LoadingSpinner size="lg" text="æ­£åœ¨åŠ è½½æœ€æ–°è½¯ä»¶..." />
        </div>
      </div>
    </div>
  </section>

  <!-- çƒ­é—¨åˆ†ç±» -->
  <section class="bg-gray-50 py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold text-gray-900">çƒ­é—¨åˆ†ç±»</h2>
        <p class="text-gray-600 mt-2">æŒ‰åˆ†ç±»æµè§ˆè½¯ä»¶</p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
        <a href="/categories/tools" class="group bg-white rounded-lg p-6 text-center hover:shadow-md transition-shadow">
          <div class="text-4xl mb-3">ğŸ”§</div>
          <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">å·¥å…·è½¯ä»¶</h3>
          <p class="text-sm text-gray-600 mt-1">å®ç”¨å·¥å…·é›†åˆ</p>
        </a>
        
        <a href="/categories/development" class="group bg-white rounded-lg p-6 text-center hover:shadow-md transition-shadow">
          <div class="text-4xl mb-3">ğŸ’»</div>
          <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">å¼€å‘å·¥å…·</h3>
          <p class="text-sm text-gray-600 mt-1">ç¼–ç¨‹å¼€å‘å¿…å¤‡</p>
        </a>
        
        <a href="/categories/design" class="group bg-white rounded-lg p-6 text-center hover:shadow-md transition-shadow">
          <div class="text-4xl mb-3">ğŸ¨</div>
          <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">è®¾è®¡è½¯ä»¶</h3>
          <p class="text-sm text-gray-600 mt-1">åˆ›æ„è®¾è®¡å·¥å…·</p>
        </a>
        
        <a href="/categories/multimedia" class="group bg-white rounded-lg p-6 text-center hover:shadow-md transition-shadow">
          <div class="text-4xl mb-3">ğŸ¬</div>
          <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">å¤šåª’ä½“</h3>
          <p class="text-sm text-gray-600 mt-1">éŸ³è§†é¢‘å¤„ç†</p>
        </a>
        
        <a href="/categories/productivity" class="group bg-white rounded-lg p-6 text-center hover:shadow-md transition-shadow">
          <div class="text-4xl mb-3">ğŸ“Š</div>
          <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">åŠå…¬è½¯ä»¶</h3>
          <p class="text-sm text-gray-600 mt-1">æå‡å·¥ä½œæ•ˆç‡</p>
        </a>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { initializeApiClient, getApiClient } from '../lib/api';
  import { apiConfig } from '../lib/config';

  // åˆå§‹åŒ– API å®¢æˆ·ç«¯
  initializeApiClient(apiConfig);

  // é¡µé¢åŠ è½½å®Œæˆåè·å–æ•°æ®
  document.addEventListener('DOMContentLoaded', async () => {
    // æµ‹è¯• API è¿æ¥
    console.log('Testing API connection...');
    console.log('API Base URL:', apiConfig.baseUrl);
    console.log('API Key:', apiConfig.apiKey ? 'Set' : 'Not set');

    await loadLatestSoftware();
    setupSearch();
  });

  // åŠ è½½æœ€æ–°è½¯ä»¶
  async function loadLatestSoftware() {
    const container = document.getElementById('latest-software-container');
    if (!container) return;

    try {
      const api = getApiClient();
      const response = await api.getSoftwareList({
        page: 1,
        limit: 6,
        sortBy: 'updatedAt',
        sortOrder: 'desc'
      });

      console.log('API Response:', response);

      if (response.success) {
        // å¤„ç†ä¸åŒçš„å“åº”æ•°æ®ç»“æ„
        let softwareList = [];

        if (response.data) {
          if (Array.isArray(response.data)) {
            // å¦‚æœ data ç›´æ¥æ˜¯æ•°ç»„
            softwareList = response.data;
          } else if (typeof response.data === 'object') {
            // å¦‚æœ data æ˜¯å¯¹è±¡ï¼Œå°è¯•æ‰¾åˆ°è½¯ä»¶æ•°ç»„
            if (response.data.software && Array.isArray(response.data.software)) {
              softwareList = response.data.software;
            } else if (response.data.items && Array.isArray(response.data.items)) {
              softwareList = response.data.items;
            } else if (response.data.list && Array.isArray(response.data.list)) {
              softwareList = response.data.list;
            } else {
              console.error('Unexpected data structure:', response.data);
              container.innerHTML = `
                <div class="text-center py-12">
                  <p class="text-red-600">æ•°æ®æ ¼å¼é”™è¯¯</p>
                  <p class="text-sm text-gray-500 mt-2">è¯·æ£€æŸ¥ API å“åº”æ ¼å¼</p>
                </div>
              `;
              return;
            }
          }
        } else {
          console.warn('No data in response:', response);
        }

        if (softwareList.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12">
              <p class="text-gray-500">æš‚æ— è½¯ä»¶æ•°æ®</p>
            </div>
          `;
          return;
        }

        // æ¸²æŸ“è½¯ä»¶å¡ç‰‡
        container.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${softwareList.map(software => `
              <div class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="p-6">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg font-semibold text-gray-900 truncate">
                        <a href="/software/${software.id}" class="hover:text-primary-600 transition-colors">
                          ${software.name}
                        </a>
                      </h3>
                      ${software.nameEn ? `<p class="text-sm text-gray-500 truncate mt-1">${software.nameEn}</p>` : ''}
                    </div>
                    <div class="flex flex-col items-end space-y-1 ml-4">
                      <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-primary-100 text-primary-800">
                        v${software.currentVersion}
                      </span>
                      ${software.category ? `
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-800">
                          ${software.category}
                        </span>
                      ` : ''}
                    </div>
                  </div>
                  ${software.description ? `
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                      ${software.description}
                    </p>
                  ` : ''}
                  <div class="flex items-center justify-between">
                    <a href="/software/${software.id}" class="btn btn-outline btn-sm">
                      æŸ¥çœ‹è¯¦æƒ…
                    </a>
                    ${software.latestDownloadUrl ? `
                      <a href="${software.latestDownloadUrl}" target="_blank" rel="noopener noreferrer" class="btn btn-primary btn-sm">
                        ä¸‹è½½
                      </a>
                    ` : ''}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
    } catch (error) {
      console.error('åŠ è½½æœ€æ–°è½¯ä»¶å¤±è´¥:', error);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack
      });

      container.innerHTML = `
        <div class="text-center py-12">
          <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">åŠ è½½å¤±è´¥</h3>
          <p class="text-gray-500 mb-4">æ— æ³•åŠ è½½è½¯ä»¶åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
          <button onclick="loadLatestSoftware()" class="btn btn-primary">
            é‡æ–°åŠ è½½
          </button>
        </div>
      `;
    }
  }

  // è®¾ç½®æœç´¢åŠŸèƒ½
  function setupSearch() {
    const searchInput = document.getElementById('hero-search');
    if (searchInput) {
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const query = (e.target as HTMLInputElement).value.trim();
          if (query) {
            window.location.href = `/search?q=${encodeURIComponent(query)}`;
          }
        }
      });
    }
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .bg-primary-600 {
    background-color: var(--color-primary-600);
  }
  
  .bg-primary-700 {
    background-color: var(--color-primary-700);
  }
  
  .text-primary-100 {
    color: var(--color-primary-100);
  }
  
  .text-primary-600 {
    color: var(--color-primary-600);
  }
  
  .bg-primary-100 {
    background-color: var(--color-primary-100);
  }
  
  .text-primary-800 {
    color: var(--color-primary-800);
  }
</style>
