---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="个人资料 - APPFUN">
  <div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">个人资料</h1>
        <p class="text-gray-600">管理您的账号信息和个人设置</p>
      </div>
      
      <!-- 登录检查 -->
      <div id="login-check" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-8">
        <div class="flex items-start space-x-3">
          <svg class="w-6 h-6 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <div>
            <h3 class="text-lg font-medium text-yellow-800 mb-2">需要登录</h3>
            <p class="text-yellow-700 mb-4">
              您需要先登录才能查看和编辑个人资料。
            </p>
            <a href="/auth/login?redirect=/auth/profile" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-yellow-800 bg-yellow-100 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
              前往登录
            </a>
          </div>
        </div>
      </div>
      
      <!-- Supabase 未配置提示 -->
      <div id="config-warning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-8">
        <div class="flex items-start space-x-3">
          <svg class="w-6 h-6 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <div>
            <h3 class="text-lg font-medium text-yellow-800 mb-2">认证系统未配置</h3>
            <p class="text-yellow-700 mb-4">
              Supabase 认证服务尚未配置。请先配置 Supabase 项目以启用个人资料功能。
            </p>
            <a href="/auth/setup" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-yellow-800 bg-yellow-100 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
              配置认证系统
            </a>
          </div>
        </div>
      </div>
      
      <div id="profile-form-container">
        <!-- 个人资料表单将在这里渲染 -->
      </div>
      
      <!-- 返回链接 -->
      <div class="mt-8 text-center">
        <a href="/" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
          ← 返回首页
        </a>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 检查认证系统是否可用
    setTimeout(() => {
      const container = document.getElementById('profile-form-container');
      const configWarning = document.getElementById('config-warning');
      const loginCheck = document.getElementById('login-check');

      if (window.authManager) {
        const authState = window.authManager.getAuthState();

        if (authState.error && authState.error.includes('Supabase 未配置')) {
          // 显示配置警告
          container.style.display = 'none';
          configWarning.classList.remove('hidden');
          return;
        }

        // 检查登录状态
        if (!authState.isLoggedIn) {
          // 显示登录提示
          container.style.display = 'none';
          loginCheck.classList.remove('hidden');
          return;
        }
      }

      // 创建个人资料表单 HTML
      if (container) {
        container.innerHTML = `
          <div class="bg-white rounded-lg shadow-md p-8">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-900">个人资料</h2>
              <p class="text-gray-600 mt-2">管理您的账号信息和个人设置</p>
            </div>

            <div id="loading-profile" class="text-center py-8">
              <div class="inline-flex items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span class="ml-2 text-gray-600">加载中...</span>
              </div>
            </div>

            <form id="profile-form" class="space-y-6 hidden">
              <div>
                <label for="user-id" class="block text-sm font-medium text-gray-700">用户ID</label>
                <input
                  id="user-id"
                  type="text"
                  disabled
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-500 font-mono"
                />
                <p class="text-xs text-gray-500 mt-1">您的唯一用户标识符</p>
              </div>

              <div>
                <label for="email" class="block text-sm font-medium text-gray-700">邮箱地址</label>
                <input
                  id="email"
                  type="email"
                  disabled
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-500"
                />
                <p class="text-xs text-gray-500 mt-1">邮箱地址无法修改</p>
              </div>

              <div>
                <label for="username" class="block text-sm font-medium text-gray-700">用户名</label>
                <input
                  id="username"
                  type="text"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="请输入用户名"
                />
              </div>

              <div>
                <label for="full-name" class="block text-sm font-medium text-gray-700">姓名</label>
                <input
                  id="full-name"
                  type="text"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="请输入您的姓名"
                />
              </div>

              <div>
                <label for="avatar-url" class="block text-sm font-medium text-gray-700">头像 URL</label>
                <input
                  id="avatar-url"
                  type="url"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="请输入头像图片链接"
                />
                <div id="avatar-preview" class="mt-2 hidden">
                  <img
                    id="avatar-img"
                    alt="头像预览"
                    class="w-16 h-16 rounded-full object-cover border border-gray-200"
                  />
                </div>
              </div>

              <div id="profile-error" class="hidden text-sm text-red-600 bg-red-50 p-3 rounded-md"></div>
              <div id="profile-success" class="hidden text-sm text-green-600 bg-green-50 p-3 rounded-md"></div>

              <div class="flex gap-3">
                <button
                  type="submit"
                  id="update-profile-btn"
                  class="flex-1 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  更新资料
                </button>
                <a
                  href="/auth/forgot-password"
                  class="flex-1 text-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  修改密码
                </a>
              </div>
            </form>
          </div>
        `;

        // 绑定表单事件
        setupProfileForm();
      }
    }, 500); // 等待认证管理器加载
  });

  async function setupProfileForm() {
    const loadingProfile = document.getElementById('loading-profile');
    const profileForm = document.getElementById('profile-form');
    const userIdInput = document.getElementById('user-id');
    const emailInput = document.getElementById('email');
    const usernameInput = document.getElementById('username');
    const fullNameInput = document.getElementById('full-name');
    const avatarUrlInput = document.getElementById('avatar-url');
    const avatarPreview = document.getElementById('avatar-preview');
    const avatarImg = document.getElementById('avatar-img');
    const profileError = document.getElementById('profile-error');
    const profileSuccess = document.getElementById('profile-success');
    const updateBtn = document.getElementById('update-profile-btn');

    // 加载用户资料
    try {
      const response = await fetch('/api/auth/profile');

      if (response.ok) {
        const data = await response.json();

        if (data.user) {
          // 填充表单数据
          if (userIdInput) userIdInput.value = `#${data.user.id}` || '';
          if (emailInput) emailInput.value = data.user.email || '';
          if (usernameInput) usernameInput.value = data.user.username || '';
          if (fullNameInput) fullNameInput.value = data.user.full_name || '';
          if (avatarUrlInput) avatarUrlInput.value = data.user.avatar || '';

          // 显示头像预览
          if (data.user.avatar && avatarImg && avatarPreview) {
            avatarImg.src = data.user.avatar;
            avatarPreview.classList.remove('hidden');
          }

          // 显示表单
          if (loadingProfile) loadingProfile.classList.add('hidden');
          if (profileForm) profileForm.classList.remove('hidden');
        } else {
          throw new Error('无法获取用户信息');
        }
      } else {
        throw new Error('加载用户资料失败');
      }
    } catch (error) {
      console.error('加载用户资料错误:', error);
      loadingProfile.innerHTML = `
        <div class="text-center py-8 text-red-600">
          <p>加载用户资料失败</p>
          <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
            重试
          </button>
        </div>
      `;
    }

    // 头像预览
    avatarUrlInput.addEventListener('input', (e) => {
      const url = e.target.value.trim();
      if (url) {
        avatarImg.src = url;
        avatarImg.onload = () => {
          avatarPreview.classList.remove('hidden');
        };
        avatarImg.onerror = () => {
          avatarPreview.classList.add('hidden');
        };
      } else {
        avatarPreview.classList.add('hidden');
      }
    });

    // 表单提交
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      updateBtn.disabled = true;
      updateBtn.textContent = '更新中...';
      profileError.classList.add('hidden');
      profileSuccess.classList.add('hidden');

      try {
        const response = await fetch('/api/auth/profile', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: usernameInput.value.trim(),
            full_name: fullNameInput.value.trim(),
            avatar_url: avatarUrlInput.value.trim(),
          }),
        });

        const data = await response.json();

        if (response.ok && data.user) {
          profileSuccess.textContent = '个人资料更新成功！';
          profileSuccess.classList.remove('hidden');

          // 触发全局认证状态更新
          if (window.authStatusIndicator) {
            window.authStatusIndicator.showCustomMessage('个人资料更新成功！', 'success');
          }

          // 触发认证状态变化事件
          window.dispatchEvent(new CustomEvent('authStateChanged', {
            detail: { profileUpdated: true }
          }));
        } else {
          profileError.textContent = data.error || '更新个人资料失败';
          profileError.classList.remove('hidden');
        }
      } catch (error) {
        console.error('更新个人资料错误:', error);
        profileError.textContent = '网络错误，请重试';
        profileError.classList.remove('hidden');
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = '更新资料';
      }
    });
  }
</script>
</Layout>
