---
import Layout from '../../layouts/Layout.astro';
import LoadingSpinner from '../../components/ui/LoadingSpinner.astro';
---

<Layout title="è½¯ä»¶æ ‡ç­¾" description="æŒ‰æ ‡ç­¾æµè§ˆè½¯ä»¶">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">è½¯ä»¶æ ‡ç­¾</h1>
      <p class="text-gray-600 mt-2">æŒ‰æ ‡ç­¾å‘ç°å’Œæµè§ˆè½¯ä»¶</p>
    </div>

    <!-- æœç´¢æ ‡ç­¾ -->
    <div class="mb-8">
      <div class="max-w-md">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <input
            type="text"
            placeholder="æœç´¢æ ‡ç­¾..."
            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
            id="tag-search"
          />
        </div>
      </div>
    </div>

    <!-- æ ‡ç­¾ç»Ÿè®¡ -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-8">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div>
          <div class="text-2xl font-bold text-gray-900" id="total-tags">-</div>
          <div class="text-sm text-gray-600">æ€»æ ‡ç­¾æ•°</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-gray-900" id="total-software-with-tags">-</div>
          <div class="text-sm text-gray-600">å·²æ ‡è®°è½¯ä»¶</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-gray-900" id="avg-tags-per-software">-</div>
          <div class="text-sm text-gray-600">å¹³å‡æ ‡ç­¾æ•°</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-gray-900" id="most-used-tag">-</div>
          <div class="text-sm text-gray-600">æœ€çƒ­é—¨æ ‡ç­¾</div>
        </div>
      </div>
    </div>

    <!-- æ’åºé€‰é¡¹ -->
    <div class="flex items-center justify-between mb-6">
      <div class="text-sm text-gray-600">
        <span id="showing-count">æ­£åœ¨åŠ è½½...</span>
      </div>
      <div class="flex items-center space-x-4">
        <label for="sort-select" class="text-sm font-medium text-gray-700">æ’åº:</label>
        <select id="sort-select" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-primary-500">
          <option value="count-desc">ä½¿ç”¨æ¬¡æ•° (é«˜åˆ°ä½)</option>
          <option value="count-asc">ä½¿ç”¨æ¬¡æ•° (ä½åˆ°é«˜)</option>
          <option value="name-asc">åç§° A-Z</option>
          <option value="name-desc">åç§° Z-A</option>
        </select>
      </div>
    </div>

    <!-- æ ‡ç­¾äº‘ -->
    <div id="tags-container">
      <div class="flex justify-center py-12">
        <LoadingSpinner size="lg" text="æ­£åœ¨åŠ è½½æ ‡ç­¾..." />
      </div>
    </div>

    <!-- æœ€è¿‘ä½¿ç”¨çš„æ ‡ç­¾ -->
    <section class="mt-16">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">æœ€è¿‘ä½¿ç”¨çš„æ ‡ç­¾</h2>
      <div id="recent-tags-container">
        <div class="flex justify-center py-8">
          <div class="animate-spin w-6 h-6 border-2 border-primary-600 border-t-transparent rounded-full"></div>
        </div>
      </div>
    </section>
  </div>
</Layout>

<script>
  import { initializeApiClient, getApiClient } from '../../lib/api';
  import { apiConfig } from '../../lib/config';

  // å®šä¹‰æ ‡ç­¾ç±»å‹
  interface TagItem {
    name: string;
    count?: number;
  }

  // åˆå§‹åŒ– API å®¢æˆ·ç«¯
  initializeApiClient(apiConfig);

  let allTags: (TagItem | string)[] = [];
  let filteredTags: (TagItem | string)[] = [];
  let currentSort: string = 'count-desc';
  let currentSearch: string = '';
  let searchTimeout: number | null = null;

  document.addEventListener('DOMContentLoaded', () => {
    loadTags();
    loadRecentTags();
    setupEventListeners();
  });

  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  function setupEventListeners() {
    // æœç´¢æ¡†
    const searchInput = document.getElementById('tag-search');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        // ç±»å‹æ–­è¨€
        const target = e.target as HTMLInputElement;
        searchTimeout = window.setTimeout(() => {
          currentSearch = target.value.trim().toLowerCase();
          filterAndRenderTags();
        }, 300);
      });
    }

    // æ’åºé€‰æ‹©
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
      sortSelect.addEventListener('change', (e) => {
        // ç±»å‹æ–­è¨€
        const target = e.target as HTMLSelectElement;
        currentSort = target.value;
        filterAndRenderTags();
      });
    }
  }

  // åŠ è½½æ ‡ç­¾
  async function loadTags() {
    try {
      const api = getApiClient();
      const response = await api.getSoftwareTags({
        includeCount: true,
        sortBy: 'count',
        sortOrder: 'desc'
      });

      if (response.success && response.data) {
        allTags = response.data.tags || [];
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateStatistics(response.data);
        
        // åˆå§‹æ¸²æŸ“
        filterAndRenderTags();
      }
    } catch (error: any) {
      console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error?.message);
      const container = document.getElementById('tags-container');
      if (container) {
        container.innerHTML = `
          <div class="text-center py-12">
            <p class="text-red-600">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
          </div>
        `;
      }
    }
  }

  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  function updateStatistics(data: any) {
    const totalTagsElement = document.getElementById('total-tags');
    const totalSoftwareElement = document.getElementById('total-software-with-tags');
    const avgTagsElement = document.getElementById('avg-tags-per-software');
    const mostUsedTagElement = document.getElementById('most-used-tag');
    
    if (totalTagsElement) {
      totalTagsElement.textContent = (data.total || 0).toString();
    }
    
    if (totalSoftwareElement) {
      totalSoftwareElement.textContent = (data.totalSoftware || 0).toString();
    }
    
    // è®¡ç®—å¹³å‡æ ‡ç­¾æ•°
    const totalTags = data.total || 0;
    const totalSoftware = data.totalSoftware || 0;
    const avgTags = totalSoftware > 0 ? (totalTags / totalSoftware).toFixed(1) : '0';
    
    if (avgTagsElement) {
      avgTagsElement.textContent = avgTags;
    }
    
    // æœ€çƒ­é—¨æ ‡ç­¾
    const mostUsedTag = Array.isArray(data.tags) && data.tags.length > 0 
      ? (typeof data.tags[0] === 'string' ? data.tags[0] : data.tags[0].name)
      : '-';
    
    if (mostUsedTagElement) {
      mostUsedTagElement.textContent = mostUsedTag;
    }
  }

  // ç­›é€‰å’Œæ¸²æŸ“æ ‡ç­¾
  function filterAndRenderTags() {
    // ç­›é€‰æ ‡ç­¾
    filteredTags = allTags.filter(tag => {
      if (!currentSearch) return true;
      const tagName = typeof tag === 'string' ? tag : tag.name;
      return tagName.toLowerCase().includes(currentSearch);
    });

    // æ’åºæ ‡ç­¾
    const [sortBy, sortOrder] = currentSort.split('-');
    filteredTags.sort((a, b) => {
      const aName = typeof a === 'string' ? a : a.name;
      const bName = typeof b === 'string' ? b : b.name;
      const aCount = typeof a === 'object' && 'count' in a && typeof a.count === 'number' ? a.count : 0;
      const bCount = typeof b === 'object' && 'count' in b && typeof b.count === 'number' ? b.count : 0;

      if (sortBy === 'name') {
        const result = aName.localeCompare(bName);
        return sortOrder === 'asc' ? result : -result;
      } else if (sortBy === 'count') {
        const result = aCount - bCount;
        return sortOrder === 'asc' ? result : -result;
      }
      return 0;
    });

    // æ›´æ–°æ˜¾ç¤ºè®¡æ•°
    const showingCount = document.getElementById('showing-count');
    if (showingCount) {
      showingCount.textContent = `æ˜¾ç¤º ${filteredTags.length} ä¸ªæ ‡ç­¾`;
    }

    // æ¸²æŸ“æ ‡ç­¾
    renderTags();
  }

  // æ¸²æŸ“æ ‡ç­¾
  function renderTags() {
    const container = document.getElementById('tags-container');
    if (!container) return;

    if (filteredTags.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12">
          <div class="text-6xl mb-4">ğŸ·ï¸</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">
            ${currentSearch ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ ‡ç­¾' : 'æš‚æ— æ ‡ç­¾'}
          </h3>
          <p class="text-gray-500">
            ${currentSearch ? `æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${currentSearch}" çš„æ ‡ç­¾` : 'è¿˜æ²¡æœ‰ä»»ä½•æ ‡ç­¾'}
          </p>
        </div>
      `;
      return;
    }

    // ç”Ÿæˆæ ‡ç­¾äº‘
    const tagElements = filteredTags.map(tag => {
      const tagName = typeof tag === 'string' ? tag : tag.name;
      const tagCount = typeof tag === 'object' && 'count' in tag && typeof tag.count === 'number' ? tag.count : 0;
      
      // æ ¹æ®ä½¿ç”¨æ¬¡æ•°è®¡ç®—æ ‡ç­¾å¤§å°
      const maxCount = Math.max(...filteredTags.map(t => 
        typeof t === 'object' && 'count' in t && typeof (t as TagItem).count === 'number' ? (t as TagItem).count! : 0
      ));
      const minSize = 0.8;
      const maxSize = 2;
      const size = tagCount > 0 ? minSize + (tagCount / maxCount) * (maxSize - minSize) : minSize;
      
      return `
        <a href="/tags/${encodeURIComponent(tagName)}" 
           class="inline-block m-2 px-4 py-2 rounded-full bg-gray-100 hover:bg-primary-100 text-gray-800 hover:text-primary-800 transition-colors font-medium"
           style="font-size: ${size}rem;">
          ${tagName}
          ${tagCount > 0 ? `<span class="ml-2 text-xs opacity-75">(${tagCount})</span>` : ''}
        </a>
      `;
    }).join('');

    container.innerHTML = `
      <div class="text-center">
        ${tagElements}
      </div>
    `;
  }

  // åŠ è½½æœ€è¿‘ä½¿ç”¨çš„æ ‡ç­¾
  async function loadRecentTags() {
    const container = document.getElementById('recent-tags-container');
    if (!container) return;

    try {
      const api = getApiClient();
      
      // è·å–æœ€è¿‘æ›´æ–°çš„è½¯ä»¶çš„æ ‡ç­¾
      const response = await api.getSoftwareList({
        page: 1,
        limit: 10,
        sortBy: 'updatedAt',
        sortOrder: 'desc'
      });

      if (response.success && response.data && Array.isArray(response.data)) {
        const recentSoftware = response.data;
        const recentTagsSet = new Set<string>();
        
        // æ”¶é›†æœ€è¿‘è½¯ä»¶çš„æ ‡ç­¾
        recentSoftware.forEach(software => {
          if (software.tags && Array.isArray(software.tags)) {
            software.tags.forEach((tag: string) => {
              if (typeof tag === 'string') {
                recentTagsSet.add(tag);
              }
            });
          }
        });

        const recentTagsArray = Array.from(recentTagsSet).slice(0, 15);

        if (recentTagsArray.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8">
              <p class="text-gray-500">æš‚æ— æœ€è¿‘ä½¿ç”¨çš„æ ‡ç­¾</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="flex flex-wrap gap-3">
            ${recentTagsArray.map(tag => `
              <a href="/tags/${encodeURIComponent(tag)}" 
                 class="inline-flex items-center px-3 py-2 rounded-full text-sm font-medium bg-primary-50 text-primary-700 hover:bg-primary-100 transition-colors">
                ${tag}
              </a>
            `).join('')}
          </div>
        `;
      }
    } catch (error: any) {
      console.error('åŠ è½½æœ€è¿‘æ ‡ç­¾å¤±è´¥:', error?.message);
      container.innerHTML = `
        <div class="text-center py-8">
          <p class="text-red-600">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
        </div>
      `;
    }
  }
</script>

<style>
  .bg-primary-50 {
    background-color: var(--color-primary-50);
  }
  
  .text-primary-700 {
    color: var(--color-primary-700);
  }
  
  .hover\:bg-primary-100:hover {
    background-color: var(--color-primary-100);
  }
  
  .bg-primary-100 {
    background-color: var(--color-primary-100);
  }
  
  .text-primary-800 {
    color: var(--color-primary-800);
  }
  
  .hover\:text-primary-800:hover {
    color: var(--color-primary-800);
  }
  
  .border-primary-600 {
    border-color: var(--color-primary-600);
  }
</style>
