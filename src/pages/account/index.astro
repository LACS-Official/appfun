---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="账户管理">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-4">账户管理</h1>
    
    <!-- 用户信息展示区域 -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">用户信息</h2>
      <div class="flex flex-col md:flex-row md:items-center gap-4">
        <div class="flex-shrink-0">
          <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
        </div>
        <div class="flex-grow">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-500">用户名</p>
              <p id="currentUsername" class="font-medium text-gray-900">AppFun-User</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">用户ID</p>
              <p class="font-medium text-gray-900">***</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 修改用户名表单 -->
    <!-- <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">修改用户名</h2>
      <form id="usernameForm" class="space-y-4">
        <div>
          <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-1">新用户名</label>
          <input 
            type="text" 
            id="newUsername" 
            name="newUsername" 
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="请输入新用户名"
            minlength="3"
            maxlength="20"
            required
          />
          <p id="usernameError" class="mt-1 text-sm text-red-600 hidden">用户名长度应在3-20个字符之间</p>
        </div>
        <div>
          <button 
            type="submit" 
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium"
          >
            保存修改
          </button>
        </div>
      </form>
    </div> -->
    
    <!-- 修改密码表单 -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">修改密码</h2>
      <form id="passwordForm" class="space-y-4">
        <div>
          <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">当前密码</label>
          <input 
            type="password" 
            id="currentPassword" 
            name="currentPassword" 
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="请输入当前密码"
            required
          />
        </div>
        <div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
          <input 
            type="password" 
            id="newPassword" 
            name="newPassword" 
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="请输入新密码"
            minlength="6"
            required
          />
          <p class="mt-1 text-xs text-gray-500">密码至少需要8个字符</p>
        </div>
        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="请再次输入新密码"
            required
          />
          <p id="passwordError" class="mt-1 text-sm text-red-600 hidden">两次输入的密码不一致</p>
        </div>
        <div>
          <button 
            type="submit" 
            class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-medium"
          >
            更新密码
          </button>
        </div>
      </form>
    </div>
    
    <script>
      // 用户名表单提交处理
      const usernameForm = document.getElementById('usernameForm') as HTMLFormElement;
      if (usernameForm) {
        usernameForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const newUsernameInput = document.getElementById('newUsername') as HTMLInputElement;
          const usernameError = document.getElementById('usernameError');
          const submitButton = usernameForm.querySelector('button[type="submit"]') as HTMLButtonElement;
          
          if (newUsernameInput && usernameError && submitButton) {
            const newUsername = newUsernameInput.value.trim();
            
            if (newUsername.length < 3 || newUsername.length > 20) {
              usernameError.classList.remove('hidden');
              return;
            }
            
            usernameError.classList.add('hidden');
            
            // 禁用提交按钮，显示加载状态
            submitButton.disabled = true;
            const originalText = submitButton.textContent;
            submitButton.textContent = '更新中...';
            
            try {
              // 调用API更新用户名 - 确保包含认证信息
            const response = await fetch('/api/profile', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              credentials: 'include', // 确保包含cookie认证信息
              body: JSON.stringify({ displayName: newUsername })
            });
              
              const data = await response.json();
              
              if (response.ok && data.data) {
                // 更新成功后更新页面上的用户名显示
                const currentUsernameElement = document.getElementById('currentUsername');
                if (currentUsernameElement) {
                  currentUsernameElement.textContent = newUsername;
                }
                alert('用户名修改成功！');
                this.reset();
              } else {
                usernameError.textContent = data.error || '用户名更新失败';
                usernameError.classList.remove('hidden');
              }
            } catch (error) {
              console.error('更新用户名时出错:', error);
              usernameError.textContent = '网络错误，请稍后重试';
              usernameError.classList.remove('hidden');
            } finally {
              // 恢复按钮状态
              submitButton.disabled = false;
              submitButton.textContent = originalText;
            }
          }
        });
      }
      
      // 密码表单提交处理
      const passwordForm = document.getElementById('passwordForm') as HTMLFormElement;
      if (passwordForm) {
        passwordForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const currentPasswordInput = document.getElementById('currentPassword') as HTMLInputElement;
          const newPasswordInput = document.getElementById('newPassword') as HTMLInputElement;
          const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;
          const passwordError = document.getElementById('passwordError');
          const submitButton = passwordForm.querySelector('button[type="submit"]') as HTMLButtonElement;
          
          if (currentPasswordInput && newPasswordInput && confirmPasswordInput && passwordError && submitButton) {
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            // 验证新密码和确认密码是否一致
            if (newPassword !== confirmPassword) {
              passwordError.textContent = '两次输入的密码不一致';
              passwordError.classList.remove('hidden');
              return;
            }
            
            // 验证新密码长度
            if (newPassword.length < 6) {
              passwordError.textContent = '密码至少需要8个字符';
              passwordError.classList.remove('hidden');
              return;
            }
            
            passwordError.classList.add('hidden');
            
            // 禁用提交按钮，显示加载状态
            submitButton.disabled = true;
            const originalText = submitButton.textContent;
            submitButton.textContent = '更新中...';
            
            try {
              // 导入Supabase客户端
              const { createClient } = await import('../../lib/supabase/client');
              const supabase = createClient();
              
              // 首先获取用户邮箱，用于密码验证
              const { data: { user } } = await supabase.auth.getUser();
              if (!user || !user.email) {
                throw new Error('用户未登录');
              }
              
              // 步骤1: 使用旧密码进行验证
              const { error: verifyError } = await supabase.auth.signInWithPassword({
                email: user.email,
                password: currentPassword
              });
              
              if (verifyError) {
                passwordError.textContent = '当前密码错误';
                passwordError.classList.remove('hidden');
                return;
              }
              
              // 步骤2: 更新密码
              const { error: updateError } = await supabase.auth.updateUser({
                password: newPassword
              });
              
              if (updateError) {
                throw updateError;
              }
              
              // 密码更新成功
              alert('密码修改成功！');
              this.reset();
            } catch (error: any) {
              console.error('更新密码时出错:', error);
              passwordError.textContent = error.message || '密码更新失败，请稍后重试';
              passwordError.classList.remove('hidden');
            } finally {
              // 恢复按钮状态
              submitButton.disabled = false;
              submitButton.textContent = originalText;
            }
          }
        });
      }
      
      // 实时验证密码是否一致
      const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;
      if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', function() {
          const newPasswordInput = document.getElementById('newPassword') as HTMLInputElement;
          const passwordError = document.getElementById('passwordError');
          
          if (newPasswordInput && passwordError) {
            const newPassword = newPasswordInput.value;
            const confirmPassword = this.value;
            
            if (confirmPassword && newPassword !== confirmPassword) {
              passwordError.classList.remove('hidden');
            } else {
              passwordError.classList.add('hidden');
            }
          }
        });
      }
    </script>
  </div>
</Layout>