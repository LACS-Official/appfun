---
// 确保页面使用动态渲染，不进行预渲染
export const prerender = false;

import { createClient } from '../../lib/supabase/server';
import Layout from '../../layouts/Layout.astro';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../../components/ui/Card.jsx';
import Button from '../../components/ui/Button.jsx';
import Input from '../../components/ui/Input.jsx';
import Label from '../../components/ui/Label.jsx';
import Avatar from '../../components/ui/Avatar.jsx';
import { Separator } from '../../components/ui/Separator.jsx';

// 创建Supabase客户端
const supabase = createClient(Astro.cookies);

// 获取当前用户信息
let user = null;
try {
  const { data } = await supabase.auth.getUser();
  user = data.user;
} catch (error) {
  console.error('获取用户信息失败:', error);
}

// 如果未登录，重定向到登录页面
if (!user) {
  return Astro.redirect('/auth/login');
}
---

<Layout title="账号设置 - 个人中心">
  <div class="flex min-h-[calc(100vh-8rem)] flex-col py-8 md:py-12">
    <div class="container max-w-5xl mx-auto px-4">
      <header class="mb-8">
        <div class="flex items-center space-x-4">
          <a href="/account" class="text-gray-500 hover:text-gray-900">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
          </a>
          <h1 class="text-3xl font-bold text-gray-900">账号设置</h1>
        </div>
        <p class="text-gray-500 mt-2">管理您的账号信息和选项</p>
      </header>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* 侧边栏 */}
        <aside className="lg:col-span-1">
          <Card className="sticky top-8">
            <CardContent className="p-6">
              <div className="flex flex-col items-center">
                <div className="relative mb-4">
                  <Avatar className="h-24 w-24 rounded-full border-4 border-white shadow-md">
                    <div className="flex h-full w-full items-center justify-center rounded-full bg-primary/10 text-primary">
                      <span className="text-3xl font-bold">{user?.email?.split('@')[0]?.charAt(0)?.toUpperCase() || 'U'}</span>
                    </div>
                  </Avatar>
                </div>
                
                <h2 className="text-xl font-semibold text-gray-900 mb-1">{user?.email?.split('@')[0] || '用户'}</h2>
                <p className="text-gray-500 text-sm mb-4">{user?.email || '未知邮箱'}</p>
                
                <div className="w-full mt-4">
                  <nav className="space-y-1">
                    <a href="/account" className="flex items-center px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                      个人资料
                    </a>
                    <a href="/account/settings" className="flex items-center px-4 py-2 text-sm font-medium rounded-md bg-primary/10 text-primary">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                      </svg>
                      账号设置
                    </a>
                    <a href="/account/security" className="flex items-center px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                      </svg>
                      安全设置
                    </a>
                  </nav>
                </div>
              </div>
            </CardContent>
          </Card>
        </aside>

        {/* 主内容区域 */}
        <main className="lg:col-span-2">
          <Card className="mb-6">
            <CardHeader>
              <CardTitle>账号信息</CardTitle>
              <CardDescription>管理您的账号基本信息</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <form id="account-info-form" className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="display-name">显示名称</Label>
                  <Input id="display-name" defaultValue={user?.user_metadata?.full_name || user?.email?.split('@')[0]} placeholder="请输入显示名称" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="email">邮箱地址</Label>
                  <div className="flex space-x-2">
                    <Input id="email" type="email" defaultValue={user?.email} disabled className="flex-1" />
                    <Button type="button" variant="secondary">更改邮箱</Button>
                  </div>
                  <p className="text-xs text-gray-500">
                    {user?.email_confirmed_at ? '邮箱已验证' : '邮箱尚未验证，点击<a href="#" class="text-primary">重新发送验证邮件</a>'}
                  </p>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="phone">手机号码（选填）</Label>
                  <Input id="phone" defaultValue={user?.phone} placeholder="请输入手机号码" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="timezone">时区</Label>
                  <select id="timezone" className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="Asia/Shanghai">中国标准时间 (UTC+8)</option>
                    <option value="America/New_York">美国东部时间 (UTC-5)</option>
                    <option value="Europe/London">伦敦时间 (UTC+0)</option>
                    <option value="Asia/Tokyo">日本时间 (UTC+9)</option>
                  </select>
                </div>
                <div className="pt-2">
                  <Button type="submit">保存更改</Button>
                </div>
              </form>
            </CardContent>
          </Card>

          <Card className="mb-6">
            <CardHeader>
              <CardTitle>通知偏好</CardTitle>
              <CardDescription>管理您希望接收的通知类型</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-6">
                <div className="space-y-4">
                  <h3 className="text-sm font-medium text-gray-900">系统通知</h3>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <div>
                        <Label htmlFor="system-email" className="text-sm font-medium text-gray-700">通过邮件接收系统通知</Label>
                        <p className="text-xs text-gray-500 mt-0.5">包括账户活动、政策更新等</p>
                      </div>
                      <input id="system-email" type="checkbox" defaultChecked className="rounded text-primary-600 focus:ring-primary-500" />
                    </div>
                    <Separator />
                    <div className="flex items-center justify-between">
                      <div>
                        <Label htmlFor="system-inapp" className="text-sm font-medium text-gray-700">应用内通知</Label>
                        <p className="text-xs text-gray-500 mt-0.5">在应用内接收系统通知</p>
                      </div>
                      <input id="system-inapp" type="checkbox" defaultChecked className="rounded text-primary-600 focus:ring-primary-500" />
                    </div>
                  </div>
                </div>
                
                <Separator />
                
                <div className="space-y-4">
                  <h3 className="text-sm font-medium text-gray-900">营销通知</h3>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <div>
                        <Label htmlFor="marketing-email" className="text-sm font-medium text-gray-700">通过邮件接收营销信息</Label>
                        <p className="text-xs text-gray-500 mt-0.5">包括新品发布、优惠活动等</p>
                      </div>
                      <input id="marketing-email" type="checkbox" className="rounded text-primary-600 focus:ring-primary-500" />
                    </div>
                  </div>
                </div>
                
                <div className="pt-4">
                  <Button type="button">保存通知设置</Button>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="text-red-600">账号管理</CardTitle>
              <CardDescription>管理您的账号状态</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-6">
                <div className="rounded-lg bg-red-50 p-4 border border-red-100">
                  <h3 className="font-medium text-red-900 mb-2">注销账号</h3>
                  <p className="text-sm text-red-700 mb-4">注销账号将永久删除您的所有数据，此操作不可撤销。</p>
                  <Button type="button" variant="destructive" className="w-full md:w-auto">注销账号</Button>
                </div>
              </div>
            </CardContent>
          </Card>
        </main>
      </div>
    </div>
  </div>

  <script>
    // 表单提交处理
    document.getElementById('account-info-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const displayName = formData.get('display-name');
      const phone = formData.get('phone');
      
      // 表单验证
      if (!displayName || displayName.trim() === '') {
        alert('显示名称不能为空');
        return;
      }
      
      try {
        // 模拟API调用更新账户信息
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // 显示成功消息
        alert('账号信息更新成功！');
      } catch (error) {
        alert('更新失败，请稍后重试');
        console.error('更新账号信息失败:', error);
      }
    });
    
    // 注销账号按钮事件处理
    document.querySelector('button[variant="destructive"]')?.addEventListener('click', () => {
      if (confirm('确定要注销您的账号吗？此操作不可撤销，所有数据将被永久删除。')) {
        // 这里应该有实际的注销账号逻辑
        alert('注销账号功能在演示版本中不可用');
      }
    });
  </script>
</Layout>